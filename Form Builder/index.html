<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Flowchart Creator (Rounded, Larger Font, Sections JSON, Zoom Scroll, Saved Flowcharts)</title>
  <!-- mxGraph -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mxgraph@4.2.2/javascript/mxClient.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/mxgraph/javascript/mxClient.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- PDF.js for PDF processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loginOverlay">
  <div id="loginForm">
    <button id="closeLoginBtn" class="close-btn">&times;</button>
    <h3>Login</h3>
    <div id="loginError"></div>
    <input type="email" id="loginEmail" placeholder="Email" /><br/>
    <input type="password" id="loginPassword" placeholder="Password" /><br/>
    <button id="loginButton">Login</button>
    <button id="signupButton">Sign Up</button>
  </div>
</div>

<div id="flowchartListOverlay">
  <div id="flowchartListPanel">
    <h3>Saved Flowcharts</h3>
    <div style="margin-bottom: 15px;">
      <input type="text" id="flowchartSearchInput" placeholder="Search flowcharts..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
    </div>
    <div id="flowchartList"></div>
    <br/>
    <button id="closeFlowchartListBtn">Close</button>
  </div>
</div>

<div class="toolbar">
  <h3>Drag And Drop Elements Below</h3>
  <div
    class="shape"
    data-type="question"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=question;nodeId=Question_node;section=1;spacing=12;fontSize=16;"
  >
    Question Node
  </div>
  <div
    class="shape"
    data-type="options"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=options;questionType=dropdown;nodeId=Option_node;section=1;spacing=12;fontSize=16;"
  >
    Options Node
  </div><br>
  <div
    class="shape"
    data-type="imageOption"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=options;questionType=imageOption;nodeId=Image_node;section=1;spacing=12;fontSize=16;"
  >
    Image Node
  </div>
  <div
    class="shape"
    data-type="pdfNode"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=pdfNode;spacing=6;fontSize=16;"
  >
    PDF Node
  </div>
  <div 
    class="shape"
    data-type="end"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=end;fillColor=#CCCCCC;fontColor=#000000;spacing=12;fontSize=16;"
  >
    End Node
  </div><br>
  <div 
    class="shape"
    data-type="amountOption"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=options;questionType=amountOption;spacing=12;fontSize=16;"
  >
    Amount Node
  </div>

  <!-- New: Calculation Node -->
  <div
    class="shape"
    data-type="calculation"
    data-style="shape=roundRect;rounded=1;arcSize=10;whiteSpace=wrap;html=1;nodeType=calculation;spacing=12;fontSize=16;pointerEvents=1;overflow=fill;"
  >
    Calculation Node
  </div>
  <div
    class="shape"
    data-type="notesNode"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=options;questionType=notesNode;spacing=12;fontSize=16;strokeWidth=3;strokeColor=#000000;"
  >
    Notes Node
  </div>
  <div
    class="shape"
    data-type="checklistNode"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=options;questionType=checklistNode;spacing=12;fontSize=16;strokeWidth=3;strokeColor=#FF0000;strokeDasharray=5,5;"
  >
    Checklist Node
  </div>
  <div
    class="shape"
    data-type="alertNode"
    data-style="shape=roundRect;rounded=1;arcSize=20;whiteSpace=wrap;html=1;nodeType=options;questionType=alertNode;spacing=12;fontSize=16;strokeWidth=3;strokeColor=#000000;strokeDasharray=5,5;"
  >
    Alert Node
  </div>

  <div class="button-bar">
    <button onclick="previewForm()">Preview Form</button><br>
    <button onclick="document.getElementById('importFlowchartFile').click()">Import Flowchart</button>
    <input
      type="file"
      id="importFlowchartFile"
      accept=".json"
      onchange="importFlowchartJson(event)"
    />
    <button onclick="exportFlowchartJson()">Export Flowchart JSON</button>
    <button onclick="exportGuiJson(true)">Export GUI JSON</button><br>
    <button onclick="exportBothJson()">Export Both</button>
    <button onclick="generateShareableUrl()">Share Flowchart URL</button>
  </div>

  <!-- Search Box -->
  <div class="search-container">
    <input type="text" id="nodeSearchBox" placeholder="Search nodes..." />
    <button id="clearSearchBtn" title="Clear search">Ã—</button>
  </div>

  <div class="legend">
    <strong>Question Types</strong><br>
    <div class="legend-item">
      <div class="legend-color-box" id="colorText"></div>
      <span>Textbox</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorCheckbox"></div>
      <span>Checkbox</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorDropdown"></div>
      <span>Dropdown</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorMoney"></div>
      <span>Number</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorDate"></div>
      <span>Date</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorDateRange"></div>
      <span>Date Range</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorEmail"></div>
      <span>Email</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorPhone"></div>
      <span>Phone</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorBigParagraph"></div>
      <span>Big Paragraph</span>
    </div>
    <div class="legend-item">
      <div class="legend-color-box" id="colorTextColor"></div>
      <span>Text Color</span>
    </div>
    <button id="resetBtn">Reset Colors</button>
  </div>

  <!-- Section Legend inserted into the toolbar above the Save Flowchart button -->
  <div id="sectionLegend">
    <h4>Section Names</h4>
    <!-- Section items will be populated dynamically -->
  </div>

  <!-- Groups Interface -->
  <div id="groupsContainer">
    <h4>Groups</h4>
    <!-- Groups will be populated dynamically -->
  </div>
  <button type="button" onclick="addGroup()">Add Group</button>

  <!-- Default PDF Properties -->
  <div id="defaultPdfPropertiesContainer">
    <h4>Default PDF Properties</h4>
    <div class="form-group">
      <label for="defaultPdfNameInput">PDF Name:</label>
      <input type="text" id="defaultPdfNameInput" placeholder="Enter default PDF name" 
             value="" oninput="updateDefaultPdfProperties()">
    </div>
    <div class="form-group">
      <label for="defaultPdfFileInput">PDF File:</label>
      <input type="text" id="defaultPdfFileInput" placeholder="Enter default PDF filename" 
             value="" oninput="updateDefaultPdfProperties()">
    </div>
    <div class="form-group">
      <label for="defaultPdfPriceInput">PDF Price:</label>
      <input type="text" id="defaultPdfPriceInput" placeholder="Enter default PDF price" 
             value="" oninput="updateDefaultPdfProperties()">
    </div>
  </div>

  <!-- Below the legends -->
  <br>
  <button id="saveFlowchartBtn" onclick="saveFlowchart()">Save</button>
  <button id="viewFlowchartBtn" onclick="viewSavedFlowcharts()">Library</button>
  <button id="settingsBtn" onclick="showSettingsMenu()">Settings</button>
  <button id="downloadSvgBtn" onclick="downloadFlowchartSvg()">Download SVG</button>
  <button id="uploadFlowchartDetailsBtn" onclick="showFlowchartDetailsModal()">Upload flowchart details</button>
  <button id="uploadDocumentPdfBtn" onclick="showDocumentPdfModal()">Upload Document PDF</button>
  <br>
  <button id="logoutBtn">Logout</button>
</div>

<div id="graphContainer"></div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu">
  <button id="copyNodeButton">Copy</button>
  <button id="deleteNode">Delete Node</button>
  <button id="jumpNode" style="display:none;">Jump</button>
  <button id="yesNoNode">Yes/No</button>
  <button id="changeType">Change Type &raquo;</button>
  <button id="newSectionNode">New Section</button>
  <button id="renameNode">Rename</button>
  <button id="propertiesButton">Properties</button>
</div>

<!-- Notes Context Menu -->
<div id="notesContextMenu" class="context-menu">
  <button id="notesBoldButton">Bold</button>
  <button id="notesFontButton">Font Size</button>
  <button id="notesCopyButton">Copy</button>
  <button id="notesDeleteButton">Delete</button>
</div>

<!-- Edge Context Menu -->
<div id="edgeContextMenu" class="context-menu">
  <button id="untangleEdge">Untangle</button>
  <button id="changeEdgeStyle">Change Style &raquo;</button>
  <button id="deleteEdge">Delete Edge</button>
</div>

<!-- Edge Style Submenu -->
<div id="edgeStyleSubmenu" class="submenu">
  <button id="edgeStyleCurved">Curved</button>
  <button id="edgeStyleDirect">Direct</button>
</div>

<!-- Empty space context menu -->
<div id="emptySpaceMenu" class="context-menu">
  <button id="pasteHereButton">Paste</button>
  <button id="placeQuestionNode">Question Node</button>
  <button id="placeOptionNode">Option Node</button>
  <button id="placeCalcNode">Calc Node</button>
  <button id="placeNotesNode">Notes Node</button>
  <button id="placeChecklistNode">Checklist Node</button>
  <button id="placeSubtitleNode">Subtitle Node</button>
  <button id="placeInfoNode">Info Node</button>
  <button id="placeImageNode">Image Node</button>
  <button id="placePdfNode">PDF Node</button>
  <button id="placeAmountNode">Amount Option Node</button>
  <button id="placeEndNode">End Node</button>
</div>

<!-- Type Submenu -->
<div id="calcSubmenu" class="submenu">
  <button id="calcType">Calculation</button>
  <button id="subtitleType">Subtitle</button>
  <button id="infoType">Info</button>
</div>

<div id="typeSubmenu" class="submenu">
  <button id="checkboxType">Checkbox</button>
  <button id="textType">Text</button>
  <button id="text2Type">Dropdown</button>
  <button id="moneyType">Number</button>
  <button id="dateType">Date</button>
  <button id="dateRangeType">Date Range</button>
  <button id="emailType">Email</button>
  <button id="phoneType">Phone</button>
  <button id="bigParagraphType">Big Paragraph</button>
  <button id="multipleTextboxesTypeBtn">Multiple Textboxes</button>
  <button id="multipleDropdownTypeBtn">Multiple Dropdown</button>
</div>

<!-- Option Type Submenu -->
<div id="optionTypeSubmenu" class="submenu">
  <button id="regularOptionType">Regular Option</button>
  <button id="imageOptionType">Image Option</button>
  <button id="amountOptionType">Amount Option</button>
  <button id="alertNodeType">Alert Node</button>
  <button id="notesNodeType">Notes Node</button>
  <button id="checklistNodeType">Checklist Node</button>
  <button id="endNodeType">End Node</button>
</div>

<div id="propertiesMenu">
  <p><strong>Node Text:</strong>
    <span id="propNodeText" class="editable-field" tabindex="0"></span>
  </p>
  <p><strong>Node ID:</strong>
    <span id="propNodeId" class="editable-field" tabindex="0"></span>
    <button id="resetNodeIdBtn" class="reset-btn" title="Reset Node ID to match naming convention">Reset</button>
  </p>
  <p><strong>Section:</strong>
    <span id="propNodeSection" class="editable-field" tabindex="0"></span>
  </p>
  <p><strong>Section Name:</strong>
    <span id="propSectionName" class="editable-field" tabindex="0"></span>
  </p>
  
  <p><strong>Question Number:</strong>
    <span id="propQuestionNumber" class="editable-field" tabindex="0"></span>
  </p>
  
  <p><strong>Node Type:</strong> <span id="propNodeType"></span></p>
  
  <div id="amountProps" style="display: none;">
    <p><strong>Amount Name:</strong>
      <span id="propAmountName" class="editable-field" tabindex="0"></span>
    </p>
    <p><strong>Amount Placeholder:</strong>
      <span id="propAmountPlaceholder" class="editable-field" tabindex="0"></span>
    </p>
  </div>
  
  <div id="pdfProps" style="display: none;">
    <p><strong>PDF Node:</strong>
      <span id="propPdfNode" class="editable-field" tabindex="0"></span>
    </p>
    <p><strong>PDF Filename:</strong>
      <span id="propPdfFilename" class="editable-field" tabindex="0"></span>
    </p>
  </div>
</div>

<!-- Settings Menu -->
<div id="settingsMenu" class="settings-menu">
  <div class="settings-container">
    <div class="settings-header">
      <h3>Settings</h3>
      <button id="closeSettingsBtn" class="close-btn">&times;</button>
    </div>
    <div class="settings-content">
      <div class="setting-item">
        <label for="edgeStyleToggle">Edge Style:</label>
        <select id="edgeStyleToggle">
          <option value="curved">Curved</option>
          <option value="straight">Straight</option>
          <option value="direct">Direct</option>
        </select>
      </div>
      <div class="setting-item">
        <label>Node Management:</label>
        <button id="resetAllNodeIdsBtn" class="reset-all-btn">Reset All Node IDs</button>
      </div>
      <div class="setting-item">
        <label>PDF Management:</label>
        <button id="resetAllPdfBtn" class="reset-all-btn">Reset PDF for all nodes</button>
      </div>
      <div class="settings-actions">
        <button id="saveSettingsBtn">Save Settings</button>
        <button id="cancelSettingsBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden color pickers -->
<input type="color" id="colorPickerText" style="display:none;" />
<input type="color" id="colorPickerCheckbox" style="display:none;" />
<input type="color" id="colorPickerDropdown" style="display:none;" />
<input type="color" id="colorPickerMoney" style="display:none;" />
<input type="color" id="colorPickerDate" style="display:none;" />
<input type="color" id="colorPickerBigParagraph" style="display:none;" />
<input type="color" id="colorPickerTextColor" style="display:none;" />
<!-- Hidden color picker for section border colors -->
<input type="color" id="sectionColorPicker" style="display:none;" />

<!-- Flowchart Details Modal -->
<div id="flowchartDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Upload Flowchart Details</h3>
      <button id="closeFlowchartDetailsModal" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <p>Describe the flowchart you want to create. Be specific about sections, questions, and question types.</p>
      <textarea id="flowchartDetailsInput" placeholder="Example: I want a flowchart with only one section called 'hunger assessment' and the only question will be a dropdown question called 'Hungry' with yes/no options." rows="6" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical;"></textarea>
      <div style="margin-top: 15px;">
        <button id="generateFlowchartBtn" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Flowchart</button>
        <button id="downloadGeneratedJsonBtn" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none;">Download Generated JSON</button>
        <button id="cancelFlowchartDetailsBtn" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
      </div>
      <div id="flowchartGenerationStatus" style="margin-top: 15px; display: none;">
        <p>Generating flowchart...</p>
      </div>
    </div>
  </div>
</div>

<!-- Document PDF Modal -->
<div id="documentPdfModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Upload Document PDF</h3>
      <button id="closeDocumentPdfModal" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <p>Upload a PDF document to automatically extract form structure and generate flowchart details.</p>
      <input type="file" id="pdfFileInput" accept=".pdf" style="width: 100%; padding: 10px; border: 2px dashed #4CAF50; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; background-color: #f9f9f9; cursor: pointer;">
      <div style="margin-top: 15px;">
        <button id="processPdfBtn" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Process PDF</button>
        <button id="downloadPdfAnalysisBtn" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none;">Download Analysis</button>
        <button id="downloadPdfAnalysisJsonBtn" style="background-color: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; display: none;">Download JSON</button>
        <button id="cancelDocumentPdfBtn" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
      </div>
      <div id="pdfProcessingStatus" style="margin-top: 15px; display: none;">
        <p>Processing PDF...</p>
      </div>
      <div id="pdfPreview" style="margin-top: 15px; display: none;">
        <h4>PDF Preview:</h4>
        <div id="pdfImagesContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;"></div>
      </div>
    </div>
  </div>
</div>

    <!-- API Configuration - loaded first (gitignored) -->
    <script src="api-config.js"></script>
    <!-- AI Features - loaded second -->
    <script src="ai-features.js"></script>
    <!-- Export functionality - loaded third -->
    <script src="export.js"></script>
    <!-- Auth functions - loaded fourth -->
    <script src="auth.js"></script>
<!-- Configuration and setup - loaded third -->
<script src="config.js"></script>
<!-- Shared dependencies - loaded third -->
<script src="dependencies.js"></script>
<!-- Node management functions - loaded fourth -->
<script src="nodes.js"></script>
<!-- Graph management - loaded fifth -->
<script src="graph.js"></script>
<!-- Calculation functions - loaded fifth -->
<script src="calc.js"></script>
<!-- Question functions - loaded sixth -->
<script src="questions.js"></script>
<!-- Context menus - loaded seventh -->
<script src="context-menus.js"></script>
<!-- Properties panel - loaded eighth -->
<script src="properties.js"></script>
<!-- Event handlers - loaded ninth -->
<script src="events.js"></script>
<!-- Section/Legend functions - loaded tenth -->
<script src="legend.js"></script>
<!-- Groups & Organization functions - loaded eleventh -->
<script src="groups.js"></script>
<!-- File I/O functions - loaded twelfth -->
<script src="library.js"></script>
<!-- URL sharing functions - loaded thirteenth -->
<script src="url.js"></script>
<!-- Main script - loaded last -->
<script src="script.js"></script>
</body>
</html>
