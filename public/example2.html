<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom Form</title>
    <link rel="stylesheet" href="generate.css">
</head>
<body>
<header>
    <img src="logo.png" alt="FormWiz Logo" width="130" height="80" onclick="location.href='index.html';">
    <nav>
        <a href="index.html">Home</a>
        <a href="forms.html">Forms</a>
        <a href="contact.html">Contact Us</a>
    </nav>
</header>

<div id="pdfPreview" style="display:none;">
    <iframe id="pdfFrame" style="display:none"></iframe>
</div>
<input type="text" id="current_date" name="current_date" placeholder="current_date" style="display:none">

<!-- Firebase includes -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<div id="questions">
    <div id="result"></div>
    <section>
    <div id="box">
        <form id="customForm" onsubmit="return showThankYouMessage();"><div id="section1" class="section active"><h2>Section 1</h2><div id="question-container-1"><label><h3>What is your age?</h3></label><input type="number" id="What_is_your_age?" name="What_is_your_age?" min="0" step="0.01" placeholder="Enter amount"><br></div><br><br><div class="navigation-buttons"><button type="button" onclick="handleNext(1)">Next</button></div></div><div id="section2" class="section"><h2>Section 2</h2><div id="question-container-2"><label><h3>What is your favorite number?</h3></label><input type="number" id="What_is_your_favorite_number?" name="What_is_your_favorite_number?" min="0" step="0.01" placeholder="Enter amount"><br></div><br><br><div class="navigation-buttons"><button type="button" onclick="navigateSection(1)">Back</button><button type="submit">Submit</button></div></div><div id="hidden_pdf_fields" style="display:none;">
<div style="display:none;">   <label class="checkbox-label">       <input type="checkbox" id="over" name="over" >       over   </label></div>
</div></form>
<div id="thankYouMessage" class="thank-you-message">Thank you for completing the survey</div>
</div>
</section>
</div>
<footer>
    &copy; 2024 FormWiz. All rights reserved.
</footer>

<script>
    // -----------------------------------------
    // Firebase initialization (if used)
    // -----------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDS-tSSn7fdLBgwzfHQ_1MPG1w8S_4qb04",
        authDomain: "formwiz-3f4fd.firebaseapp.com",
        projectId: "formwiz-3f4fd",
        storageBucket: "formwiz-3f4fd.appspot.com",
        messagingSenderId: "404259212529",
        appId: "1:404259212529:web:15a33bce82383b21cfed50",
        measurementId: "G-P07YEN0HPD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    const formId = urlParams.get("formId");
    let userId = null;

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            userId = user.uid;
        } else {
            console.log("User not logged in.");
            window.location.href = "account.html";
        }
    });

    // questionNameIds used for logic & jump
    var questionNameIds = {"1":"What_is_your_age?","2":"What_is_your_favorite_number?"};
    var jumpLogics = [];
    var conditionalPDFs = [];
    var conditionalAlerts = [];

    function handleNext(currentSection) {
        var nextSection = currentSection + 1;
        var relevantJumps = [];
        for(var i=0; i<jumpLogics.length; i++){
            if(jumpLogics[i].section == currentSection){
                relevantJumps.push(jumpLogics[i]);
            }
        }
        for(var j=0; j<relevantJumps.length; j++){
            var jlogic = relevantJumps[j];
            var questionId = jlogic.questionId;
            var questionType = jlogic.questionType;
            var jumpOption = jlogic.jumpOption;
            var jumpTo = jlogic.jumpTo;
            var nameId = questionNameIds[questionId] || ("answer" + questionId);

            if(questionType === "radio" || questionType === "dropdown"){
                var el = document.getElementById(nameId);
                if(el && el.value && el.value.trim().toLowerCase() === jumpOption.trim().toLowerCase()){
                    nextSection = jumpTo;
                    break;
                }
            } else if(questionType === "checkbox"){
                var cbs = document.querySelectorAll('input[id^="answer' + questionId + '_"]');
                if(cbs && cbs.length){
                    var chosen = [];
                    for(var c=0; c<cbs.length; c++){
                        if(cbs[c].checked){
                            chosen.push(cbs[c].value.trim().toLowerCase());
                        }
                    }
                    if(chosen.indexOf(jumpOption.trim().toLowerCase()) !== -1){
                        nextSection = jumpTo;
                        break;
                    }
                }
            }
        }
        navigateSection(nextSection);
        runAllHiddenCheckboxCalculations();
    }

    function navigateSection(sectionNumber) {
        var sections = document.querySelectorAll(".section");
        for(var i=0; i<sections.length; i++){
            sections[i].classList.remove("active");
        }
        var target = document.getElementById("section" + sectionNumber);
        if(target){
            target.classList.add("active");
        } else {
            // if user typed end or invalid
            sections[sections.length - 1].classList.add("active");
        }
    }

    function setCurrentDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, "0");
        var mm = String(today.getMonth() + 1).padStart(2, "0");
        var yyyy = today.getFullYear();
        today = yyyy + "-" + mm + "-" + dd;
        document.getElementById("current_date").value = today;
    }
    window.onload = function() {
        setCurrentDate();
        attachCalculationListeners();
    };

    function handleConditionalAlerts() {
        for(var i=0; i<conditionalAlerts.length; i++){
            var obj = conditionalAlerts[i];
            var prevQ = document.getElementById("answer" + obj.prevQuestionId);
            if(prevQ){
                if(prevQ.value.trim().toLowerCase() === obj.prevAnswer.trim().toLowerCase()){
                    alert(obj.alertText);
                }
            } else {
                var cbs = document.querySelectorAll('[name^="answer' + obj.prevQuestionId + '_"]');
                for(var c=0; c<cbs.length; c++){
                    if(cbs[c].checked && cbs[c].value.trim().toLowerCase() === obj.prevAnswer.trim().toLowerCase()){
                        alert(obj.alertText);
                    }
                }
            }
        }
    }

    function showThankYouMessage() {
        var pdfName = "test.pdf".replace(".pdf", "");
        editAndDownloadPDF(pdfName).then(function(){
            for(var i=0; i<conditionalPDFs.length; i++){
                var pdfObj = conditionalPDFs[i];
                if(pdfObj.questionType === "checkbox"){
                    var cbox = document.getElementById(pdfObj.questionNameId);
                    if(cbox && cbox.checked && cbox.value === pdfObj.conditionalAnswer){
                        editAndDownloadPDF(pdfObj.pdfName.replace(".pdf",""));
                    }
                } else {
                    var val = "";
                    var valEl = document.getElementById(pdfObj.questionNameId);
                    if(valEl){ val = valEl.value; }
                    if(val === pdfObj.conditionalAnswer){
                        editAndDownloadPDF(pdfObj.pdfName.replace(".pdf",""));
                    }
                }
            }
            handleConditionalAlerts();
            document.getElementById("customForm").style.display = "none";
            document.getElementById("thankYouMessage").style.display = "block";
        });
        return false;
    }

    function downloadPDF(url, filename) {
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
    }
    async function editAndDownloadPDF(pdfName) {
        var formData = new FormData();
        var inputs = document.querySelectorAll("#questions input, #questions select, #questions textarea");
        for(var i=0; i<inputs.length; i++){
            var inp = inputs[i];
            if(inp.type === "checkbox"){
                formData.append(inp.name, inp.checked ? "Yes" : "No");
            } else {
                formData.append(inp.name, inp.value);
            }
        }
        return fetch("/edit_pdf?pdf=" + pdfName, { method: "POST", body: formData })
            .then(function(res){ return res.blob(); })
            .then(function(blob){
                var url = URL.createObjectURL(blob);
                downloadPDF(url, "Edited_" + pdfName + ".pdf");
            });
    }

    /***********************************************
     * Hidden Checkbox Calculations
     ***********************************************/
    var hiddenCheckboxCalculations = [{"hiddenFieldName":"over","calculations":[{"questionNameId1":"What_is_your_age?","mathOp":"+","questionNameId2":"What_is_your_favorite_number?","operator":">","threshold":"100","result":"checked"}]}];

    // Evaluate all calculations at once
    function runAllHiddenCheckboxCalculations() {
        if(!hiddenCheckboxCalculations || hiddenCheckboxCalculations.length === 0) return;
        for(var i=0; i<hiddenCheckboxCalculations.length; i++){
            runSingleHiddenCheckboxCalculation(hiddenCheckboxCalculations[i]);
        }
    }

    // Evaluate one hidden checkbox's calculations
    function runSingleHiddenCheckboxCalculation(calcObj) {
        // calcObj = {
        //   hiddenFieldName: "someCheckboxName",
        //   calculations: [
        //       {
        //         questionNameId1,
        //         mathOp,
        //         questionNameId2,
        //         operator, // =, <, >
        //         threshold,
        //         result // "checked" or "unchecked"
        //       }
        //   ]
        // }
        var hiddenCheckbox = document.getElementById(calcObj.hiddenFieldName);
        if(!hiddenCheckbox) return;

        // last matching condition wins
        var finalState = hiddenCheckbox.checked;
        for(var c=0; c<calcObj.calculations.length; c++){
            var cond = calcObj.calculations[c];

            // read question1
            var val1 = 0;
            if(cond.questionNameId1) {
                var qEl1 = document.getElementById(cond.questionNameId1);
                if(qEl1) {
                    val1 = parseFloat(qEl1.value) || 0;
                }
            }
            // read question2 if mathOp
            var val2 = 0;
            if(cond.mathOp && cond.questionNameId2) {
                var qEl2 = document.getElementById(cond.questionNameId2);
                if(qEl2){
                    val2 = parseFloat(qEl2.value) || 0;
                }
            }
            // compute combinedVal
            var combinedVal = val1;
            if(cond.mathOp === '+') {
                combinedVal = val1 + val2;
            } else if(cond.mathOp === '-') {
                combinedVal = val1 - val2;
            } else if(cond.mathOp === 'x') {
                combinedVal = val1 * val2;
            } else if(cond.mathOp === '/') {
                if(val2 !== 0) {
                    combinedVal = val1 / val2;
                } else {
                    combinedVal = 0; // or Infinity? 
                }
            }

            // compare combinedVal with threshold
            var thresholdNum = parseFloat(cond.threshold) || 0;
            var isMatch = false;
            if(cond.operator === '=') {
                isMatch = (combinedVal === thresholdNum);
            } else if(cond.operator === '<') {
                isMatch = (combinedVal < thresholdNum);
            } else if(cond.operator === '>') {
                isMatch = (combinedVal > thresholdNum);
            }

            if(isMatch){
                finalState = (cond.result === "checked");
            }
        }
        hiddenCheckbox.checked = finalState;
    }

    function attachCalculationListeners() {
        if(!hiddenCheckboxCalculations) return;
        for(var i=0; i<hiddenCheckboxCalculations.length; i++){
            var calcObj = hiddenCheckboxCalculations[i];
            for(var j=0; j<calcObj.calculations.length; j++){
                var c = calcObj.calculations[j];
                // questionNameId1
                if(c.questionNameId1) {
                    var qEl1 = document.getElementById(c.questionNameId1);
                    if(qEl1){
                        qEl1.addEventListener("change", function(){
                            runAllHiddenCheckboxCalculations();
                        });
                    }
                }
                // questionNameId2
                if(c.questionNameId2) {
                    var qEl2 = document.getElementById(c.questionNameId2);
                    if(qEl2){
                        qEl2.addEventListener("change", function(){
                            runAllHiddenCheckboxCalculations();
                        });
                    }
                }
            }
        }
    }
    </script>
</body>
</html>