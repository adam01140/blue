
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom Form</title>
    <link rel="stylesheet" href="generate.css">
    <!-- Stripe.js include -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      /* Info icon and tooltip styles */
      .question-header {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .info-icon {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 1px solid #007bff;
        border-radius: 50%;
        color: #007bff;
        font-size: 14px;
        line-height: 18px;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
      }
      .info-icon .info-tooltip {
        visibility: hidden;
        top: calc(100% + 5px);
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        width: 200px;
        z-index: 100;
        font-weight: normal;
        font-size: 14px;
        line-height: 1.4;
        text-align: left;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .info-icon:hover .info-tooltip,
      .info-icon:focus .info-tooltip {
        visibility: visible;
        opacity: 1;
      }
      .info-icon .info-tooltip::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent #333 transparent;
      }
      /* Progress Bar Styles */
      .progress-bar-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto 20px auto;
        padding: 0 0 10px 0;
        background: none;
      }
      .progress-bar-bg {
        width: 100%;
        height: 18px;
        background: linear-gradient(90deg, #e0e7ef 0%, #f5f7fa 100%);
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(44,62,80,0.07);
        overflow: hidden;
        position: relative;
      }
      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #4f8cff 0%, #38d39f 100%);
        border-radius: 10px 0 0 10px;
        width: 0%;
        transition: width 0.5s cubic-bezier(.4,1.4,.6,1), background 0.3s;
        box-shadow: 0 2px 8px rgba(44,62,80,0.13);
        position: absolute;
        left: 0;
        top: 0;
      }
      .progress-bar-label {
        position: absolute;
        width: 100%;
        text-align: center;
        top: 0;
        left: 0;
        height: 100%;
        line-height: 18px;
        font-size: 13px;
        color: #2c3e50;
        font-weight: 600;
        letter-spacing: 0.5px;
        pointer-events: none;
        z-index: 2;
        text-shadow: 0 1px 2px #fff, 0 0 2px #fff;
      }
      .navigation-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 10px;
      }
      .navigation-buttons button {
        width: auto;
        max-width: none;
        margin: 0;
        display: inline-flex;
      }
      /* Stepper Progress Bar Styles */
      .stepper-progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 12px auto 0 auto;
        width: 100%;
        max-width: 700px;
        background: none;
        gap: 0;
      }
      .stepper-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        min-width: 90px;
      }
      .stepper-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e0e7ef;
        color: #2c3e50;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        border: 2px solid #4f8cff;
        transition: background 0.3s, color 0.3s, border 0.3s;
      }
      .stepper-step.active .stepper-circle,
      .stepper-step.completed .stepper-circle {
        background: linear-gradient(90deg, #4f8cff 0%, #38d39f 100%);
        color: #fff;
        border: 2px solid #38d39f;
      }
      .stepper-label {
        margin-top: 8px;
        font-size: 15px;
        color: #2c3e50;
        font-weight: 600;
        text-align: center;
        min-width: 80px;
      }
      .stepper-step.completed .stepper-label {
        color: #38d39f;
      }
      .stepper-step.active .stepper-label {
        color: #4f8cff;
      }
      .stepper-line {
        flex: 1;
        height: 4px;
        background: #e0e7ef;
        margin: 0 0px;
        position: relative;
        z-index: 1;
        transition: background 0.5s cubic-bezier(.4,1.4,.6,1);
      }
      .stepper-line.filled {
        background: linear-gradient(90deg, #4f8cff 0%, #38d39f 100%);
      }
      /* Custom Modal Styles */
      .custom-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(44, 62, 80, 0.45);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s;
      }
      .custom-modal {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(44,62,80,0.18);
        padding: 32px 28px 24px 28px;
        max-width: 370px;
        width: 90%;
        text-align: center;
        position: relative;
        animation: modalPopIn 0.35s cubic-bezier(.4,1.4,.6,1);
      }
      @keyframes modalPopIn {
        0% { transform: scale(0.85); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
      }
      .custom-modal h2 {
        margin-top: 0;
        color: #2c3e50;
        font-size: 1.35rem;
        font-weight: 700;
        margin-bottom: 12px;
      }
      .custom-modal p {
        color: #4f8cff;
        font-size: 1.08rem;
        margin-bottom: 28px;
      }
      .custom-modal .modal-buttons {
        display: flex;
        gap: 18px;
        justify-content: center;
      }
      .custom-modal button {
        padding: 8px 22px;
        border-radius: 6px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      .custom-modal .modal-back {
        background: #e0e7ef;
        color: #2c3e50;
      }
      .custom-modal .modal-back:hover {
        background: #cfd8e3;
      }
      .custom-modal .modal-continue {
        background: linear-gradient(90deg, #4f8cff 0%, #38d39f 100%);
        color: #fff;
        border: none;
      }
      .custom-modal .modal-continue:hover {
        background: linear-gradient(90deg, #38d39f 0%, #4f8cff 100%);
      }
    </style>
</head>
<body>
<div id="loginRequiredModal" class="custom-modal-overlay" style="display:none;">
  <div class="custom-modal">
    <h2>Account Required</h2>
    <p>You must create an account to continue filling out the form.</p>
    <div class="modal-buttons">
      <button class="modal-back" id="modalBackBtn" type="button">Back</button>
      <button class="modal-continue" id="modalContinueBtn" type="button">Continue</button>
            </div>
          </div>
</div>
<header>
    <img src="logo.png" alt="FormWiz Logo" width="130" height="80" onclick="location.href='index.html';">
    <nav>
        <a href="index.html">Home</a>
        <a href="forms.html">Forms</a>
        <a href="contact.html">Contact Us</a>
    </nav>
</header>

<div id="pdfPreview" style="display:none;">
    <iframe id="pdfFrame" style="display:none"></iframe>
            </div>
<input type="text" id="current_date" name="current_date" placeholder="current_date" style="display:none">

<!-- Firebase includes -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

          <script>
/*──────── mirror a dropdown → textbox and checkbox ────────*/
function dropdownMirror(selectEl, baseName){
    const wrap = document.getElementById("dropdowntext_"+baseName);
    if(!wrap) return;

    const val = selectEl.value.trim();
    if(!val) {
        wrap.innerHTML = "";
        return;
    }

    const textId = baseName + "_dropdown";
    const textField = document.getElementById(textId);
    
    if(textField) {
        textField.value = val;
        textField.style.display = "none";
    }

    const existingCheckboxes = wrap.querySelectorAll("div");
    existingCheckboxes.forEach(div => div.remove());

    const idSuffix = val.replace(/\W+/g, "_").toLowerCase();
    const checkboxId = baseName + "_" + idSuffix;
    
    const checkboxDiv = document.createElement("div");
    checkboxDiv.style.display = "none";
    checkboxDiv.innerHTML = "<input type='checkbox' id='" + checkboxId + "' name='" + checkboxId + "' checked>" +
                     "<label for='" + checkboxId + "'> " + baseName + "_" + idSuffix + "</label>";
    
    wrap.appendChild(checkboxDiv);
    handleLinkedDropdowns(baseName, val);
}

let isHandlingLink = false;

function handleLinkedDropdowns(sourceName, selectedValue) {
    if (!linkedDropdowns || linkedDropdowns.length === 0 || isHandlingLink) return;
    
    try {
        isHandlingLink = true;  // Set flag before handling links
        linkedDropdowns.forEach(linkPair => {
            if (linkPair.sourceNameId === sourceName) {
                const targetDropdown = document.getElementById(linkPair.targetNameId);
                if (targetDropdown && targetDropdown.value !== selectedValue) {  // Only if value is different
                    let optionExists = false;
                    for (let i = 0; i < targetDropdown.options.length; i++) {
                        if (targetDropdown.options[i].value === selectedValue) {
                            optionExists = true;
                            targetDropdown.value = selectedValue;
                            // Trigger change event only if value actually changed
                            const event = new Event("change");
                            targetDropdown.dispatchEvent(event);
              break;
            }
          }
                    if (!optionExists && selectedValue) {
                        console.warn("Option '" + selectedValue + "' does not exist in linked dropdown " + linkPair.targetNameId);
                    }
                }
            }
            else if (linkPair.targetNameId === sourceName) {
                const sourceDropdown = document.getElementById(linkPair.sourceNameId);
                if (sourceDropdown && sourceDropdown.value !== selectedValue) {  // Only if value is different
                    let optionExists = false;
                    for (let i = 0; i < sourceDropdown.options.length; i++) {
                        if (sourceDropdown.options[i].value === selectedValue) {
                            optionExists = true;
                            sourceDropdown.value = selectedValue;
                            // Trigger change event only if value actually changed
                            const event = new Event("change");
                            sourceDropdown.dispatchEvent(event);
                            break;
                        }
                    }
                    if (!optionExists && selectedValue) {
                        console.warn("Option '" + selectedValue + "' does not exist in linked dropdown " + linkPair.sourceNameId);
                    }
                }
            }
        });
    } finally {
        isHandlingLink = false;  // Always reset flag when done
    }
}
</script>

<div style="width: 80%; max-width: 800px; margin: 20px auto; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; display: none;">
    <h3 style="text-align: center; margin-bottom: 15px; color: #2c3e50;">Your Information</h3>
    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
        <div style="flex: 1;">
            <label for="user_firstname" style="display: block; margin-bottom: 5px; font-weight: bold;">First Name</label>
            <input type="text" form="customForm" id="user_firstname" name="user_firstname" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
            <label for="user_lastname" style="display: block; margin-bottom: 5px; font-weight: bold;">Last Name</label>
            <input type="text" form="customForm" id="user_lastname" name="user_lastname" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
    </div>
    <div style="margin-bottom: 15px;">
        <label for="user_email" style="display: block; margin-bottom: 5px; font-weight: bold;">Email Address</label>
        <input type="email" form="customForm" id="user_email" name="user_email" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <div style="margin-bottom: 15px;">
        <label for="user_phone" style="display: block; margin-bottom: 5px; font-weight: bold;">Phone Number</label>
        <input type="tel" form="customForm" id="user_phone" name="user_phone" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <div style="margin-bottom: 15px;">
        <label for="user_street" style="display: block; margin-bottom: 5px; font-weight: bold;">Street Address</label>
        <input type="text" form="customForm" id="user_street" name="user_street" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
        <div style="flex: 2;">
            <label for="user_city" style="display: block; margin-bottom: 5px; font-weight: bold;">City</label>
            <input type="text" form="customForm" id="user_city" name="user_city" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
            <label for="user_state" style="display: block; margin-bottom: 5px; font-weight: bold;">State</label>
            <input type="text" form="customForm" id="user_state" name="user_state" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
            <label for="user_zip" style="display: block; margin-bottom: 5px; font-weight: bold;">ZIP</label>
            <input type="text" form="customForm" id="user_zip" name="user_zip" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
    </div>
</div>
<div id="questions">
    <div id="result"></div>
    <section>
    <div id="box">
        <form id="customForm" onsubmit="return showThankYouMessage();"><div class="stepper-progress-bar" id="stepperProgressBar"><div class="stepper-step" data-step="1"><div class="stepper-circle">1</div><div class="stepper-label">Section 1</div></div><div class="stepper-line"></div><div class="stepper-step" data-step="2"><div class="stepper-circle">2</div><div class="stepper-label">Section 2</div></div></div><div id="section1" class="section active"><center><h1 class="section-title">Section 1</h1><div id="question-container-1"><label><h3>Do you have a lawyer</h3></label><input type="text" id="answer1" name="answer1" placeholder=""><br></div><br><br><div class="navigation-buttons"><button type="button" onclick="handleNext(1)">Next</button></div></center></div><div id="section2" class="section "><center><h1 class="section-title">Section 2</h1><div id="question-container-2"><label><h3>Hungry?</h3></label><select id="answer2" name="answer2" onchange="dropdownMirror(this, 'answer2')"><option value="" disabled selected>Select an option</option></select><br><div id="dropdowntext_answer2"></div><input type="text" id="answer2_dropdown" name="answer2_dropdown" readonly style="display:none;"></div><br><br><div class="navigation-buttons"><button type="button" onclick="goBack()">Back</button><button type="submit">Submit</button></div></center></div><div id="hidden_pdf_fields">
<input type="hidden" id="user_firstname_hidden" name="user_firstname_hidden">
<input type="hidden" id="user_lastname_hidden"  name="user_lastname_hidden">
<input type="hidden" id="user_email_hidden"     name="user_email_hidden">
<input type="hidden" id="user_phone_hidden"     name="user_phone_hidden">
<input type="hidden" id="user_street_hidden"    name="user_street_hidden">
<input type="hidden" id="user_city_hidden"      name="user_city_hidden">
<input type="hidden" id="user_state_hidden"     name="user_state_hidden">
<input type="hidden" id="user_zip_hidden"       name="user_zip_hidden">
</div></form>
<div id="thankYouMessage" class="thank-you-message">Thank you for completing the survey</div>
</div>
</section>
</div>
<footer>
    &copy; 2024 FormWiz. All rights reserved.
</footer>
<script>

/*───────────────────────────────*
 * return the true checkbox prefix
 *───────────────────────────────*/
function getCbPrefix (qId){
    if (questionSlugMap[qId]) return questionSlugMap[qId] + '_';
    if (questionNameIds[qId]) return questionNameIds[qId] + '_';
    return 'answer' + qId + '_';
}

/*───────────────────────────────*
 * buildCheckboxName(questionId, rawNameId, labelText)
 *───────────────────────────────*/
function buildCheckboxName (questionId, rawNameId, labelText){
    const slugPrefix = (questionSlugMap[questionId] || ('answer' + questionId)) + '_';
    let namePart = (rawNameId || '').trim();
    if (!namePart){
        namePart = labelText.replace(/\W+/g, '_').toLowerCase();
    }
    if (!namePart.startsWith(slugPrefix)){
        namePart = slugPrefix + namePart;
    }
    return namePart;
}

    let isUserLoggedIn = false;
    const firebaseConfig = {
        apiKey: "AIzaSyDS-tSSn7fdLBgwzfHQ_1MPG1w8S_4qb04",
        authDomain: "formwiz-3f4fd.firebaseapp.com",
        projectId: "formwiz-3f4fd",
        storageBucket: "formwiz-3f4fd.appspot.com",
        messagingSenderId: "404259212529",
        appId: "1:404259212529:web:15a33bce82383b21cfed50",
        measurementId: "G-P07YEN0HPD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    const formId = urlParams.get("formId");
    let userId = null;
    firebase.auth().onAuthStateChanged(async function(user){
        if(user){ 
            isUserLoggedIn = true;
            userId=user.uid;
            // Fetch user data and display welcome message
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if(userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('user_firstname').value = userData.firstName || '';
                    document.getElementById('user_lastname').value = userData.lastName || '';
                    document.getElementById('user_email').value = userData.email || '';
                    document.getElementById('user_phone').value = userData.phone || '';
                    document.getElementById('user_street').value = userData.address?.street || '';
                    document.getElementById('user_city').value = userData.address?.city || '';
                    document.getElementById('user_state').value = userData.address?.state || '';
                    document.getElementById('user_zip').value = userData.address?.zip || '';
                }
            } catch(error) {
                console.error("Error fetching user data:", error);
            }
        } else {
            isUserLoggedIn = false;
            // Do NOT redirect. Just let the user fill the form.
        }
    });
  var questionSlugMap       = {};
var questionNameIds = {"1":"answer1","2":"answer2"};
var jumpLogics = [];
var conditionalPDFs = [];
var conditionalAlerts = [];
var labelMap = {"length":0};
var amountMap = {"length":0};
var linkedDropdowns = [];
var sectionStack = [];
var currentSectionNumber = 1;
var pdfFileName = "form.pdf";
var additionalPdfFileNames = [];
var allPdfFileNames = [pdfFileName, ...additionalPdfFileNames];
var hiddenCheckboxCalculations = [];
var hiddenTextCalculations = [];

/*──── main submit handler ────*/
function showThankYouMessage () {
    processAllPdfs().then(() => {
        document.getElementById('customForm').style.display = 'none';
        document.getElementById('thankYouMessage').style.display = 'block';
    });
    return false;                       // prevent page reload
}

/*──── process all PDFs sequentially ────*/
async function processAllPdfs() {
    for (const pdfName of allPdfFileNames) {
        if (pdfName) {
            await editAndDownloadPDF(pdfName);
        }
    }
}

/*──── build FormData with **everything inside the form** ────*/
async function editAndDownloadPDF (pdfName) {
    /* this grabs every control that belongs to <form id="customForm">,
       including those specified with form="customForm" attributes   */
    const fd = new FormData(document.getElementById('customForm'));

    // Use the /edit_pdf endpoint with the PDF name as a query parameter
    // Remove the .pdf extension if present since server adds it automatically
    const baseName = pdfName.replace(/.pdf$/i, '');
    const res = await fetch('/edit_pdf?pdf=' + encodeURIComponent(baseName), { 
        method: 'POST', 
        body: fd 
    });
    
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    // trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Edited_' + pdfName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // inline preview - only show the last one
    const frame = document.getElementById('pdfFrame');
    frame.src = url;
    frame.style.display = 'block';
    document.getElementById('pdfPreview').style.display = 'none';
}
  
  
  function sanitizeQuestionText (str){
    return String(str)
       .toLowerCase()
        .replace(/\W+/g, "_")   // ← double "\" so the HTML gets "\W"
        .replace(/^_+|_+$/g, "");
}

// Phone number formatter function
function formatPhoneNumber(value) {
  if (!value) return value;
  
  const phoneNumber = value.replace(/\D/g, '');
  const phoneNumberLength = phoneNumber.length;
  
  if (phoneNumberLength < 4) {
    return phoneNumberLength > 0 ? '(' + phoneNumber : '';
  } else if (phoneNumberLength < 7) {
    return '(' + phoneNumber.substring(0, 3) + ') ' + phoneNumber.substring(3);
  } else {
    return '(' + phoneNumber.substring(0, 3) + ') ' + 
           phoneNumber.substring(3, 6) + '-' + 
           phoneNumber.substring(6, 10);
  }
}

// Initialize all phone inputs on the page
document.addEventListener('DOMContentLoaded', function() {
  const phoneInputs = document.querySelectorAll('.phone-input');
  
  phoneInputs.forEach(phoneInput => {
    // Format existing value if any
    if (phoneInput.value) {
      phoneInput.value = formatPhoneNumber(phoneInput.value);
    }
    
    // Set up event listener for input
    phoneInput.addEventListener('input', function(e) {
      const input = e.target;
      const value = input.value.replace(/\D/g, '').substring(0, 10); // Strip non-digits and limit to 10 digits
      input.value = formatPhoneNumber(value);
    });
  });
});


function toggleAmountField(amountFieldId, show) {
    const amountField = document.getElementById(amountFieldId);
    if (amountField) {
        amountField.style.display = show ? 'block' : 'none';
        if (!show) amountField.value = '';
    }
}

/*──────────────────────────────────────────────────────────────*
 * Handle "None of the above" checkbox functionality
 *──────────────────────────────────────────────────────────────*/
function toggleNoneOption(checkbox, questionId) {
    if (!checkbox.checked) return;

    // Find the "None of the above" checkbox using more robust selectors
    const cbPrefix = getCbPrefix(questionId);
    const noneCheckbox = document.querySelector('input[id="' + cbPrefix + 'none"]') || 
                         document.querySelector('input[id^="' + cbPrefix + '"][id$="_none"]');
                         
    if (noneCheckbox && noneCheckbox.checked) {
        // Uncheck the "None of the above" option when any other option is checked
        noneCheckbox.checked = false;
    }
}


// AUTOSAVE, RESTORE, AND WIPE LOGIC FOR ALL GENERATED FORMS
(function() {
    // Wait for Firebase and DOM
    function onReady(fn) {
        if (document.readyState !== 'loading') fn();
        else document.addEventListener('DOMContentLoaded', fn);
    }
    onReady(function() {
        if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) return;
        const db = firebase.firestore();
        const urlParams = new URLSearchParams(window.location.search);
        const formId = urlParams.get('formId') || window.formId || 'default';
        let userId = null;
        let isUserLoggedIn = false;

        // Stripe Keys - Placed within scope
        // WARNING: Using LIVE keys for local development is not recommended and will likely fail.
        const STRIPE_PUBLIC_KEY = 'pk_live_51RcD0sFJeSRMFQ8X5rliD5AD1etCL6QwozQjkmUoCG5iULUAqPLFjm4aejihXCZNjsQF1cfSVug5lXe0NKns1TEY00SWDPlDAz';
        // IMPORTANT: Replace this with the actual TEST Price ID for your product.
        const STRIPE_PRICE_ID = 'price_1RcDedFJeSRMFQ8XmelYMbkc';

        // Helper: get all form fields to save
        function getFormFields() {
            const form = document.getElementById('customForm');
            if (!form) return [];
            return Array.from(form.elements).filter(el =>
                el.name &&
                !el.disabled &&
                ['INPUT', 'TEXTAREA', 'SELECT'].includes(el.tagName) &&
                !['hidden', 'button', 'submit', 'reset'].includes(el.type)
            );
        }

        // Helper: save answers
        async function saveAnswers() {
            if (!isUserLoggedIn || !userId) return;
            const fields = getFormFields();
            const answers = {};
            fields.forEach(el => {
                if (el.type === 'checkbox' || el.type === 'radio') {
                    answers[el.name] = el.checked;
                } else {
                    answers[el.name] = el.value;
                }
            });
            await db.collection('users').doc(userId).collection('formAnswers').doc(formId).set(answers, { merge: true });
        }

        // Helper: load answers
        async function loadAnswers() {
            if (!isUserLoggedIn || !userId) return;
            try {
                const doc = await db.collection('users').doc(userId).collection('formAnswers').doc(formId).get();
                if (doc.exists) {
                    const data = doc.data();
                    const fields = getFormFields();
                    fields.forEach(el => {
                        if (data.hasOwnProperty(el.name)) {
                            if (el.type === 'checkbox' || el.type === 'radio') {
                                el.checked = !!data[el.name];
                            } else {
                                el.value = data[el.name];
                            }
                        }
                    });
                }
            } catch (e) {
                // ignore
            }
        }

        // Helper: wipe answers
        function wipeAnswers() {
            if (!isUserLoggedIn || !userId) return;
            db.collection('users').doc(userId).collection('formAnswers').doc(formId).delete();
        }

        // Attach listeners to all fields
        function attachAutosaveListeners() {
            const fields = getFormFields();
            fields.forEach(el => {
                el.addEventListener('input', saveAnswers);
                el.addEventListener('change', saveAnswers);
            });
        }
        
        // Payment Modal Logic
        function showPaymentModal() {
            const modal = document.createElement('div');
            modal.id = 'stripe-payment-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(44,62,80,0.45)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '99999';
            modal.innerHTML = `
              <div style="background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(44,62,80,0.18); padding:32px 28px 24px 28px; max-width:370px; width:90%; text-align:center; position:relative;">
                <h2>Payment Required</h2>
                <p>To download your completed PDF, please complete payment.</p>
                <button id="stripeCheckoutBtn" style="background:linear-gradient(90deg,#4f8cff 0%,#38d39f 100%); color:#fff; border:none; border-radius:6px; padding:10px 28px; font-size:1.1em; font-weight:600; cursor:pointer;">Pay & Download</button>
                <br><br>
                <button id="cancelPaymentBtn" style="background:#e0e7ef; color:#2c3e50; border:none; border-radius:6px; padding:8px 22px; font-size:1em; font-weight:600; cursor:pointer;">Cancel</button>
              </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('cancelPaymentBtn').onclick = function() {
              document.body.removeChild(modal);
            };
            document.getElementById('stripeCheckoutBtn').onclick = function() {
              startStripeCheckout();
            };
        }

        async function startStripeCheckout() {
            await saveAnswers();
            const stripe = Stripe(STRIPE_PUBLIC_KEY);
            try {
                const response = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        priceId: STRIPE_PRICE_ID,
                        formId: formId
                    })
                });
                const data = await response.json();
                if (data.sessionId) {
                    stripe.redirectToCheckout({ sessionId: data.sessionId });
                } else {
                    alert('Error: Could not create payment session.');
                }
            } catch (error) {
                console.error('Payment Error:', error);
                alert('A payment error occurred. Please try again.');
            }
        }

        // On auth state change
        firebase.auth().onAuthStateChanged(function(user) {
            isUserLoggedIn = !!user;
            userId = user ? user.uid : null;
            if (isUserLoggedIn) {
                const params = new URLSearchParams(window.location.search);
                if (params.get('payment') === 'success') {
                    console.log('Payment successful! Processing PDF...');
                    loadAnswers().then(() => {
                        processAllPdfs().then(() => {
                            wipeAnswers();
                            // Use the correct path for redirecting after success
                            window.history.replaceState({}, document.title, "/example.html");
                        });
                    });
                } else {
                    loadAnswers().then(attachAutosaveListeners);
                }
            }
        });

        // On form submit
        const form = document.getElementById('customForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                showPaymentModal();
                return false;
            });
        }
    });
})();
</script>
</body>
</html>
