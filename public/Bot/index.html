<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormWiz - Simplify Your Paperwork</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="../Pages/cart.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Cart functionality -->
    <script src="../Pages/cart.js"></script>
    <!-- AI Configuration removed - now handled server-side -->
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: 'Montserrat', sans-serif;
            color: #333;
            background-color: #eaf1f8;
            zoom: 0.90;
        }
        header {
            background-color: #2c3e50;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        header img {
            cursor: pointer;
        }
        nav {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 38px;
            z-index: 2;
        }
        nav a {
            color: #fff;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.18em;
            letter-spacing: 0.02em;
            padding: 2px 8px;
            transition: color 0.2s, background 0.2s, box-shadow 0.2s;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }
        nav a:hover {
            color: #ff7043;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 2px 8px rgba(44,62,80,0.10);
        }
        .nav-chevron {
            display: inline-block;
            margin-left: 6px;
            width: 14px;
            height: 14px;
            vertical-align: middle;
        }
        .nav-chevron svg {
            display: block;
            width: 100%;
            height: 100%;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-left: auto;
        }
        .sign-in-btn {
            background: #fff;
            color: #222;
            font-weight: 700;
            font-size: 1.08em;
            border: none;
            border-radius: 22px;
            padding: 8px 28px;
            margin-left: 18px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(44,62,80,0.10);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            text-decoration: none;
            outline: none;
        }
        .sign-in-btn:hover {
            background: #f4f4f4;
            color: #2980b9;
            box-shadow: 0 4px 16px rgba(44,62,80,0.13);
        }
        .nav-dropdown-wrapper {
            position: relative;
            display: inline-block;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            left: 0;
            top: 38px;
            background: #fff;
            min-width: 210px;
            box-shadow: 0 4px 24px rgba(44,62,80,0.13);
            border-radius: 10px;
            z-index: 1002;
            padding: 12px 0;
            flex-direction: column;
            gap: 0;
        }
        .dropdown-menu a {
            color: #222;
            padding: 12px 28px;
            text-decoration: none;
            display: block;
            font-weight: 600;
            font-size: 1.08em;
            border-radius: 0;
            transition: background 0.18s, color 0.18s;
        }
        .dropdown-menu a:hover {
            background: #eaf1f8;
            color: #2980b9;
        }
        .nav-dropdown-wrapper.open .dropdown-menu {
            display: flex;
            animation: dropdownFadeIn 0.22s cubic-bezier(0.4,0,0.2,1);
        }
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .forms-chevron {
            transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
        }
        .nav-dropdown-wrapper.open .forms-chevron {
            transform: rotate(-90deg);
        }
        .btn {
            background-color: #2980b9;
            color: #ffffff;
            padding: 15px 50px;
            font-size: 1.2em;
            text-decoration: none;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            flex-direction: column;
            cursor: pointer;
        }
        .tiny-click-here {
            font-size: 0.8em;
            color: #d6e6f7;
            font-weight: 400;
            margin-top: 2px;
            letter-spacing: 0.5px;
        }
        .btn:hover {
            background-color: #1c598a;
        }
        .steps {
            display: grid;
            grid-template-columns: repeat(3, minmax(150px, 1fr));
            justify-items: center;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }
        .step {
            text-align: center;
        }
        footer {
            text-align: center;
            padding: 20px;
            background-color: #2c3e50;
            color: white;
        }
        /* Media query for smaller screens */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 10px;
            }
            nav {
                position: static;
                transform: none;
                margin-top: 10px;
            }
            .steps {
                grid-template-columns: 1fr;
                max-width: 100%;
            }
        }
        /* Make main content flexible */
        main {
            flex: 1;
        }
        /* How It Works Section */
        .how-it-works {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.08);
            max-width: 900px;
            margin: 40px auto 20px auto;
            padding: 30px 20px 20px 20px;
            text-align: center;
        }
        .how-it-works h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 25px;
            font-family: 'Montserrat', serif;
        }
        .hiw-steps {
            display: flex;
            justify-content: space-around;
            gap: 30px;
            flex-wrap: wrap;
        }
        .hiw-step {
            display: flex;
            align-items: flex-start;
            gap: 28px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 40px;
            padding: 88px 38px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.06);
            cursor: pointer;
            transition: box-shadow 0.2s, background 0.2s;
            min-height: 220px;
            width: 100%;
        }
        .hiw-step-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            margin-right: 24px;
        }
        .hiw-step-number {
            font-size: 3.5em;
            color: #2980b9;
            font-weight: bold;
            font-family: 'Montserrat', serif;
            line-height: 1;
        }
        .hiw-inline-img {
            display: block;
            margin: 18px 0 0 0;
            width: 120px;
            height: 120px;
            object-fit: contain;
        }
        .hiw-step-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .hiw-step h3 {
            margin: 0 0 18px 0;
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
        }
        .hiw-step p {
            color: #555;
            font-size: 1.3em;
            margin: 0;
            font-weight: 400;
        }
        .hiw-step.active, .hiw-step:hover {
            background: #eaf1f8;
            box-shadow: 0 2px 8px rgba(44,62,80,0.10);
        }
        /* FAQ / Help Section */
        .faq-help {
            background: #f8fafc;
            border-radius: 38px;
            max-width: 1400px;
            margin: 60px auto 30px auto;
            padding: 72px 60px 60px 60px;
            box-shadow: 0 8px 48px rgba(44,62,80,0.10);
            font-size: 0.7em !important;
        }
        .faq-help h2 {
            color: #2c3e50;
            font-size: 1em !important;
            margin-bottom: 38px;
            font-family: 'Montserrat', serif;
        }
        .faq-item {
            margin-bottom: 48px;
        }
        .faq-item h4 {
            color: #2980b9;
            margin-bottom: 12px;
            font-size: 2.2em !important;
        }
        .faq-item p {
            color: #444;
            font-size: 1.7em !important;
            line-height: 1.6;
        }
        /* Legal Disclaimer */
        .legal-disclaimer {
            background: #fffbe6;
            color: #7a5c00;
            border: 1px solid #ffe58f;
            border-radius: 38px;
            max-width: 1400px;
            margin: 60px auto 0 auto;
            padding: 72px 60px 60px 60px;
            font-size: 1.35em;
            box-shadow: 0 8px 48px rgba(44,62,80,0.10);
            text-align: center;
        }
        /* Responsive for new sections */
        @media (max-width: 900px) {
            .hiw-steps {
                flex-direction: column;
                gap: 10px;
            }
        }
        .hero-renovated {
            background: transparent;
            padding: 48px 0 32px 0;
            display: flex;
            justify-content: center;
        }
        .hero-container {
            background: #2c3e50;
            border-radius: 38px;
            display: flex;
            align-items: stretch;
            justify-content: center;
            padding: 48px 40px 40px 40px;
            max-width: 1500px;
            width: 100%;
            box-shadow: 0 4px 32px rgba(24,49,58,0.10);
            gap: 36px;
            min-height: 320px;
        }
        .hero-img {
            width: 210px;
            height: 210px;
            object-fit: cover;
            border-radius: 24px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.10);
            opacity: 1 !important;
            transform: none !important;
            transition: none !important;
        }
        .hero-img-left {
            margin-right: 0;
        }
        .hero-img-right {
            margin-left: 0;
            align-self: flex-end;
        }
        .hero-content {
            flex: 1 1 400px;
            text-align: center;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            min-height: 210px;
            position: relative;
            z-index: 1;
        }
        .hero-content h1 {
            font-size: 3.2em;
            font-family: 'Montserrat', serif;
            font-weight: 700;
            margin-bottom: 18px;
            line-height: 1.08;
            opacity: 0;
            transform: translateY(-32px);
            transition: opacity 0.6s cubic-bezier(0.4,0,0.2,1), transform 0.6s cubic-bezier(0.4,0,0.2,1);
        }
        .hero-content h1.hero-animate {
            opacity: 1;
            transform: translateY(0);
        }
        .hero-highlight {
            color: #ff7043;
            font-weight: 700;
        }
        .hero-highlight-orange { color: #ff7043; font-weight: 700; }
        .hero-content p {
            font-size: 1.5em;
            color: #e0e6ea;
            margin-bottom: 32px;
            font-weight: 400;
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        .hero-content p.hero-animate {
            opacity: 1;
        }
        .hero-btn {
            margin: 0 auto;
            font-size: 1.15em;
            padding: 15px 48px;
        }
        @media (max-width: 1500px) {
            .hero-container {
                max-width: 1100px;
            }
        }
        @media (max-width: 900px) {
            .hero-container {
                flex-direction: column;
                padding: 32px 10px 24px 10px;
                gap: 18px;
                max-width: 98vw;
            }
            .hero-img {
                width: 160px;
                height: 160px;
                align-self: center;
            }
            .hero-content h1 {
                font-size: 2em;
            }
        }
        @media (max-width: 600px) {
            .hero-container {
                padding: 18px 2vw 12px 2vw;
            }
            .hero-content h1 {
                font-size: 1.2em;
            }
            .hero-content p {
                font-size: 1em;
            }
            .hiw-step {
                flex-direction: column;
                align-items: center;
                padding: 40px 10px;
                min-height: 120px;
            }
            .hiw-step-left {
                flex-direction: row;
                min-width: 0;
                margin-right: 0;
                margin-bottom: 12px;
            }
            .hiw-inline-img {
                width: 80px;
                height: 80px;
            }
        }
        /* How it works */
        .howitworks-wrapper {
            background: #fff;
            padding: 40px 0 40px 0;
        }
        .howitworks {
            display: flex;
            max-width: 1300px;
            margin: 0 auto;
            gap: 40px;
            align-items: flex-start;
        }
        .hiw-image-area {
            position: sticky;
            top: 120px;
            margin-right: 20px;
            max-width: 600px;
            min-width: 340px;
            width: 38vw;
            height: 490px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #f4f4f4;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.08);
            padding-top: 30px;
            padding-left: 32px;
            padding-right: 32px;
            padding-bottom: 32px;
        }
        .hiw-image-header {
            text-align: center;
            margin-bottom: 18px;
        }
        .hiw-image-header h2 {
            font-size: 2.2em;
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-family: 'Montserrat', serif;
        }
        .hiw-image-header p {
            font-size: 1.15em;
            color: #444;
            margin: 0;
        }
        .hiw-image {
            display: none;
           
            transition: opacity 0.4s;
        }
        .hiw-image.active {
            display: block;
            opacity: 1;
        }
        .hiw-steps-area {
            flex: 2;
            max-width: 900px;
        }
        .hiw-steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .hiw-step {
            display: flex;
            align-items: flex-start;
            gap: 28px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 40px;
            padding: 88px 38px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.06);
            cursor: pointer;
            transition: box-shadow 0.2s, background 0.2s;
            min-height: 220px;
            width: 100%;
        }
        .hiw-step.active, .hiw-step:hover {
            background: #eaf1f8;
            box-shadow: 0 2px 8px rgba(44,62,80,0.10);
        }
        .hiw-step-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            margin-right: 24px;
        }
        .hiw-step-number {
            font-size: 3.5em;
            color: #2980b9;
            font-weight: bold;
            font-family: 'Montserrat', serif;
            line-height: 1;
        }
        .hiw-inline-img {
            display: block;
            margin: 18px 0 0 0;
            width: 120px;
            height: 120px;
            object-fit: contain;
        }
        .hiw-step-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .hiw-step h3 {
            margin: 0 0 18px 0;
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
        }
        .hiw-step p {
            color: #555;
            font-size: 1.3em;
            margin: 0;
            font-weight: 400;
        }
        /* FAQ / Help Section */
        .faq-help {
            background: #f8fafc;
            border-radius: 10px;
            max-width: 1000px;
            margin: 40px auto 20px auto;
            padding: 25px 100px 25px 100px;
            box-shadow: 0 1px 6px rgba(44,62,80,0.05);
        }
        .faq-help h2 {
            color: #2c3e50;
            font-size: 0.1em;
            margin-bottom: 18px;
            font-family: 'Montserrat', serif;
        }
        .faq-help h1 {
            color: #2c3e50;
            font-size: 3em;
            margin-bottom: 18px;
            font-family: 'Montserrat', serif;
        }
        .faq-item {
            margin-bottom: 18px;
        }
        .faq-item h4 {
            color: #2980b9;
            margin-bottom: 5px;
            font-size: 0.1em;
        }
        .faq-item p {
            color: #444;
            font-size: 0.1em;
        }
        /* Legal Disclaimer */
        .legal-disclaimer {
            background: #fffbe6;
            color: #7a5c00;
            border: 1px solid #ffe58f;
            border-radius: 8px;
            max-width: 1030px;
            margin: 30px auto 0 auto;
            padding: 18px 20px;
            font-size: 1em;
            box-shadow: 0 1px 4px rgba(44,62,80,0.04);
            text-align: center;
        }
        /* Responsive */
        @media (max-width: 1100px) {
            .howitworks {
                flex-direction: column;
                align-items: stretch;
            }
            .hiw-image-area {
                position: static;
                margin: 0 auto 30px auto;
                width: 100%;
                max-width: 420px;
                padding-left: 16px;
                padding-right: 16px;
                padding-bottom: 20px;
            }
        }
        .nav-dropdown-wrapper {
            position: relative;
            display: inline-block;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            left: 0;
            top: 38px;
            background: #fff;
            min-width: 210px;
            box-shadow: 0 4px 24px rgba(44,62,80,0.13);
            border-radius: 10px;
            z-index: 10;
            padding: 12px 0;
            flex-direction: column;
            gap: 0;
        }
        .dropdown-menu a {
            color: #222;
            padding: 12px 28px;
            text-decoration: none;
            display: block;
            font-weight: 600;
            font-size: 1.08em;
            border-radius: 0;
            transition: background 0.18s, color 0.18s;
        }
        .dropdown-menu a:hover {
            background: #eaf1f8;
            color: #2980b9;
        }
        .nav-dropdown-wrapper.open .dropdown-menu {
            display: flex;
            animation: dropdownFadeIn 0.22s cubic-bezier(0.4,0,0.2,1);
        }
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .forms-chevron {
            transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
        }
        .nav-dropdown-wrapper.open .forms-chevron {
            transform: rotate(-90deg);
        }
        @media (max-width: 768px) {
            .dropdown-menu {
                left: 0;
                right: 0;
                min-width: unset;
                width: 100vw;
                border-radius: 0 0 10px 10px;
            }
        }
        .services-showcase {
            background: #fff;
            border-radius: 0 0 38px 38px;
            margin: 0 auto 40px auto;
            padding: 38px 0 32px 0;
            box-shadow: 0 4px 32px rgba(24,49,58,0.07);
            max-width: 1200px;
        }
        .services-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 32px;
            max-width: 1100px;
            margin: 0 auto;
        }
        .service-card {
            background: #f8fafc;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.08);
            padding: 32px 28px 28px 28px;
            width: 230px;
            min-height: 210px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: box-shadow 0.18s, background 0.18s, transform 0.18s;
            text-align: center;
        }
        .service-card:hover {
            background: #eaf1f8;
            box-shadow: 0 4px 18px rgba(44,62,80,0.13);
            transform: translateY(-4px) scale(1.03);
        }
        .service-icon {
            font-size: 2.6em;
            margin-bottom: 18px;
        }
        .service-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .service-desc {
            font-size: 1.05em;
            color: #555;
        }
        @media (max-width: 900px) {
            .services-container {
                gap: 18px;
            }
            .service-card {
                width: 44vw;
                min-width: 180px;
                padding: 22px 10px 18px 10px;
            }
        }
        @media (max-width: 600px) {
            .services-container {
                flex-direction: column;
                align-items: center;
            }
            .service-card {
                width: 90vw;
                min-width: unset;
            }
        }
        .hero-services-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 38px 0 0 0;
            width: 100%;
        }
        .hero-service-card {
            background: #22313f;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.10);
            padding: 22px 18px 18px 18px;
            width: 170px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: box-shadow 0.18s, background 0.18s, transform 0.18s;
            text-align: center;
            border: 1.5px solid #2c3e50;
        }
        .hero-service-card:hover {
            background: #314d6a;
            box-shadow: 0 4px 18px rgba(44,62,80,0.13);
            transform: translateY(-3px) scale(1.04);
        }
        .hero-service-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .hero-service-title {
            font-size: 1.08em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }
        .hero-service-desc {
            font-size: 0.98em;
            color: #e0e6ea;
        }
        @media (max-width: 1200px) {
            .hero-services-row {
                gap: 12px;
            }
            .hero-service-card {
                width: 140px;
                padding: 16px 6px 12px 6px;
            }
        }
        @media (max-width: 900px) {
            .hero-services-row {
                gap: 8px;
            }
            .hero-service-card {
                width: 40vw;
                min-width: 120px;
                padding: 12px 2vw 10px 2vw;
            }
        }
        @media (max-width: 600px) {
            .hero-services-row {
                flex-direction: column;
                align-items: center;
            }
            .hero-service-card {
                width: 90vw;
                min-width: unset;
            }
        }
        /* Remove old services section styles */
        .services-showcase, .services-container, .service-card, .service-icon, .service-title, .service-desc { display: none !important; }
        .hero-container.hero-ultrawide {
            max-width: 1800px;
            width: 100vw;
            min-width: 1200px;
            padding-left: 0;
            padding-right: 0;
            gap: 36px;
        }
        .hero-content.hero-content-ultrawide {
            flex: 1 1 1200px;
            min-width: 900px;
            align-items: flex-start;
            text-align: left;
            padding-left: 0;
            padding-right: 0;
        }
        .hero-img-right.hero-img-grandpa {
            align-self: flex-start;
            margin-left: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        .hero-services-row.hero-services-row-ultrawide {
            display: flex;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: stretch;
            gap: 22px;
            margin: 38px 0 0 0;
            width: 100%;
        }
        .hero-service-card {
            background: #22313f;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.10);
            padding: 22px 18px 18px 18px;
            width: 200px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: box-shadow 0.18s, background 0.18s, transform 0.18s;
            text-align: center;
            border: 1.5px solid #2c3e50;
            flex: 0 0 200px;
        }
        .hero-service-card:hover {
            background: #314d6a;
            box-shadow: 0 4px 18px rgba(44,62,80,0.13);
            transform: translateY(-3px) scale(1.04);
        }
        .hero-service-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .hero-service-title {
            font-size: 1.08em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }
        .hero-service-desc {
            font-size: 0.98em;
            color: #e0e6ea;
        }
        @media (max-width: 1800px) {
            .hero-container.hero-ultrawide {
                max-width: 100vw;
                min-width: 0;
            }
            .hero-content.hero-content-ultrawide {
                min-width: 0;
            }
        }
        @media (max-width: 1400px) {
            .hero-service-card {
                width: 160px;
                flex: 0 0 160px;
            }
            .hero-content.hero-content-ultrawide {
                min-width: 0;
            }
        }
        @media (max-width: 1200px) {
            .hero-services-row.hero-services-row-ultrawide {
                gap: 10px;
            }
            .hero-service-card {
                width: 120px;
                flex: 0 0 120px;
                padding: 16px 6px 12px 6px;
            }
        }
        @media (max-width: 900px) {
            .hero-container.hero-ultrawide {
                flex-direction: column;
                align-items: stretch;
            }
            .hero-content.hero-content-ultrawide {
                min-width: unset;
                align-items: center;
                text-align: center;
            }
            .hero-services-row.hero-services-row-ultrawide {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            .hero-service-card {
                width: 40vw;
                min-width: 120px;
                flex: 0 0 40vw;
                padding: 12px 2vw 10px 2vw;
            }
        }
        @media (max-width: 600px) {
            .hero-services-row.hero-services-row-ultrawide {
                flex-direction: column;
                align-items: center;
            }
            .hero-service-card {
                width: 90vw;
                min-width: unset;
                flex: 0 0 90vw;
            }
        }
        .hero-container.hero-gridfit {
            
            width: 95%;
            margin: 0 auto;
            padding-left: 60px;
            padding-right: 60px;
            gap: 36px;
            box-sizing: border-box;
        }
        .hero-content.hero-content-gridfit {
            flex: 1 1 1000px;
            min-width: 700px;
            align-items: flex-start;
            text-align: left;
            padding-left: 0;
            padding-right: 0;
        }
        .hero-services-row.hero-services-row-gridfit {
            display: grid;
            grid-template-columns: repeat(7, minmax(100px, 1fr));
            gap: 100px;
            margin: 38px 0 0 0;
            width: 100%;
            box-sizing: border-box;
            justify-items: center;
        }
        .hero-service-card {
            background: #22313f;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.10);
            padding: 44px 40px 40px 40px;
            width: 100%;
            min-width: 0;
            max-width: 500px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: box-shadow 0.18s, background 0.18s, transform 0.18s;
            text-align: center;
            border: 1.5px solid #2c3e50;
        }
        .hero-service-card:hover {
            background: #314d6a;
            box-shadow: 0 4px 18px rgba(44,62,80,0.13);
            transform: translateY(-3px) scale(1.04);
        }
        .hero-service-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .hero-service-title {
            font-size: 1.08em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }
        .hero-service-desc {
            font-size: 0.98em;
            color: #e0e6ea;
        }
        .hero-img-right.hero-img-grandpa {
            align-self: flex-start;
            margin-left: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        @media (max-width: 1500px) {
            .hero-container.hero-gridfit {
                max-width: 98vw;
            }
        }
        @media (max-width: 1200px) {
            .hero-services-row.hero-services-row-gridfit {
                grid-template-columns: repeat(2, 1fr);
                gap: 32px;
            }
            .hero-service-card {
                max-width: 90vw;
            }
        }
        @media (max-width: 900px) {
            .hero-container.hero-gridfit {
                flex-direction: column;
                align-items: stretch;
            }
            .hero-content.hero-content-gridfit {
                min-width: unset;
                align-items: center;
                text-align: center;
            }
            .hero-services-row.hero-services-row-gridfit {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .hero-service-card {
                width: 90vw;
                max-width: unset;
                padding: 12px 2vw 10px 2vw;
            }
        }
        
        /* AI Lawyer Assistant Styles */
        .ai-lawyer-container {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(44, 62, 80, 0.12);
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            animation: containerSlideIn 0.6s ease-out;
        }
        
        @keyframes containerSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-lawyer-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .ai-lawyer-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }
        
        .avatar-icon {
            font-size: 2.5em;
        }
        
        .ai-lawyer-info h1 {
            margin: 0 0 8px 0;
            font-size: 2.2em;
            font-weight: 700;
        }
        
        .ai-lawyer-info p {
            margin: 0 0 12px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-text {
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 500px;
            background: #f8fafc;
            min-height: 300px;
            scroll-behavior: smooth;
        }
        
        .message {
            display: flex;
            margin-bottom: 20px;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .ai-message .message-avatar {
            background: #2980b9;
            color: white;
            font-size: 1.2em;
        }
        
        .user-message .message-avatar {
            background: #e74c3c;
            color: white;
            font-size: 1.2em;
        }
        
        .message-content {
            background: white;
            padding: 18px 22px;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            max-width: 85%;
            line-height: 1.6;
            word-wrap: break-word;
        }
        
        .ai-message .message-content {
            background: #e8f4fd;
            border-bottom-left-radius: 4px;
        }
        
        .user-message .message-content {
            background: #ffe8e8;
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .user-message .message-avatar {
            margin-right: 0;
            margin-left: 12px;
        }
        
        .message-content p {
            margin: 0 0 10px 0;
        }
        
        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        .message-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .message-content li {
            margin-bottom: 5px;
        }
        
        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e8ed;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #666;
            font-style: italic;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #2980b9;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f8fafc;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            padding: 15px 22px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .input-wrapper:focus-within {
            border-color: #2980b9;
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }
        
        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 1em;
            line-height: 1.4;
            max-height: 120px;
            min-height: 24px;
        }
        
        .send-button {
            background: #2980b9;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .send-button:hover {
            background: #1c598a;
        }
        
        .send-button:active {
            transform: scale(0.95);
        }
        
        .send-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
        }
        
        .char-count {
            font-weight: 500;
        }
        
        .disclaimer-text {
            font-style: italic;
        }

        /* Form Recommendation Module Styles */
        .form-recommendation-module {
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4fd 100%);
            border: 2px solid #2980b9;
            border-radius: 16px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 8px 32px rgba(41, 128, 185, 0.15);
            position: relative;
            overflow: hidden;
        }

        .form-recommendation-module::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2980b9 0%, #4f8cff 100%);
        }

        .form-module-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .form-module-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #2980b9 0%, #4f8cff 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(41, 128, 185, 0.3);
        }

        .form-module-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .form-module-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .form-module-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin: 4px 0 0 0;
        }

        .form-module-description {
            color: #555;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .form-module-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .form-get-started-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .form-get-started-btn:hover {
            background: linear-gradient(135deg, #219150 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .form-get-started-btn:active {
            transform: translateY(0);
        }

        .form-module-info {
            font-size: 0.9em;
            color: #7f8c8d;
            font-style: italic;
        }

        /* Animation for module appearance */
        @keyframes formModuleSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-recommendation-module {
            animation: formModuleSlideIn 0.5s ease-out;
        }
        
        .quick-actions {
            padding: 25px;
            background: #f8fafc;
            border-top: 1px solid #e1e8ed;
        }
        
        .quick-actions h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .quick-btn {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 20px;
            padding: 10px 18px;
            font-size: 0.9em;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .quick-btn:hover {
            border-color: #2980b9;
            color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(41, 128, 185, 0.15);
        }
        
        .quick-btn:active {
            transform: translateY(0);
        }
        
        /* Responsive Design for AI Assistant */
        @media (max-width: 768px) {
            main {
                padding: 10px !important;
            }
            .ai-lawyer-container {
                width: 100%;
                margin: 0;
                border-radius: 15px;
                min-height: calc(100vh - 40px);
            }
            
            .ai-lawyer-header {
                padding: 20px;
                flex-direction: column;
                text-align: center;
            }
            
            .ai-lawyer-avatar {
                width: 60px;
                height: 60px;
            }
            
            .avatar-icon {
                font-size: 2em;
            }
            
            .ai-lawyer-info h1 {
                font-size: 1.8em;
            }
            
            .chat-messages {
                padding: 15px;
                max-height: 400px;
            }
            
            .message-content {
                max-width: 90%;
                padding: 12px 16px;
            }
            
            .chat-input-container {
                padding: 15px;
            }
            
            .quick-actions {
                padding: 15px;
            }
            
            .quick-buttons {
                gap: 8px;
            }
            
            .quick-btn {
                font-size: 0.85em;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .ai-lawyer-header {
                padding: 15px;
            }
            
            .ai-lawyer-info h1 {
                font-size: 1.5em;
            }
            
            .ai-lawyer-info p {
                font-size: 1em;
            }
            
            .message-content {
                max-width: 95%;
                padding: 10px 14px;
            }
            
            .input-wrapper {
                padding: 10px 15px;
            }
            
            .send-button {
                width: 35px;
                height: 35px;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        /* County Modal Styles */
        #county-modal .modal-content {
            text-align: center;
            max-width: 500px;
        }
        #county-modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        #county-modal p {
            font-size: 1.1em;
            margin: 20px 0;
            line-height: 1.5;
            color: #34495e;
        }
        #county-modal .btn {
            width: auto;
            padding: 12px 30px;
            margin: 0;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            cursor: pointer;
            color: white;
        }
        #county-modal-submit {
            background-color: #2980b9;
        }
        #county-modal-submit:hover {
            background-color: #1c598a;
        }
        #county-modal-cancel {
            background-color: #95a5a6;
        }
        #county-modal-cancel:hover {
            background-color: #7f8c8d;
        }

        /* Defendant Modal Styles */
        #defendant-modal .modal-content {
            text-align: center;
            max-width: 500px;
        }
        #defendant-modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        #defendant-modal p {
            font-size: 1.1em;
            margin: 20px 0;
            line-height: 1.5;
            color: #34495e;
        }
        #defendant-modal .btn {
            width: auto;
            padding: 12px 30px;
            margin: 0;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            cursor: pointer;
            color: white;
        }
        #defendant-modal-submit {
            background-color: #2980b9;
        }
        #defendant-modal-submit:hover {
            background-color: #1c598a;
        }
        #defendant-modal-cancel {
            background-color: #95a5a6;
        }
        #defendant-modal-cancel:hover {
            background-color: #7f8c8d;
        }
    </style>
</head>
<body>
    <header>
        <img src="logo.png" alt="FormWiz Logo" width="130" height="80" onclick="location.href='../index.html';">
        <nav>
            <a href="../index.html">Home
                <span class="nav-chevron"><svg viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L5 5L9 1" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            </a>
            <div class="nav-dropdown-wrapper" id="forms-dropdown-wrapper">
                <a href="#" id="forms-nav-link">Forms
                    <span class="nav-chevron forms-chevron"><svg viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L5 5L9 1" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </a>
                <div class="dropdown-menu" id="forms-dropdown-menu">
                    <a href="../Pages/forms.html">My Forms</a>
                    <a href="../Pages/FreeForm.html">Free Form</a>
                    <a href="../Pages/Immigration.html">Immigration</a>
                    <a href="../Pages/smallclaims.html">Small Claims</a>
                    <a href="../Pages/Other.html">Other</a>
                </div>
            </div>
            <a href="../Pages/about.html">About Us
                <span class="nav-chevron"><svg viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L5 5L9 1" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            </a>
            <a href="../Pages/contact.html">Contact Us
                <span class="nav-chevron"><svg viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L5 5L9 1" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            </a>
            <a href="../Pages/FAQ.html">FAQ
                <span class="nav-chevron"><svg viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L5 5L9 1" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            </a>
        </nav>
        <div class="header-actions">
            <a href="../Pages/account.html" class="sign-in-btn" id="sign-in-btn">Sign In</a>
            <a href="#" class="sign-in-btn" id="logout-btn" style="display:none;">Log Out</a>
            <a href="#" id="cart-icon-link" style="margin-left: -10px; display: inline-flex; align-items: center; text-decoration: none; position: relative;">
                <span class="cart-circle">
                    <svg id="cart-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="10" cy="21" r="1.5"/>
                        <circle cx="18" cy="21" r="1.5"/>
                        <path d="M2.5 4H5l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L21.5 7H6.16"/>
                    </svg>
                    <span id="cart-count-badge" style="display: none; position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #e74c3c; color: #fff; border-radius: 50%; font-size: 1em; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 4px rgba(44,62,80,0.13); z-index: 2; text-align: center;"></span>
                </span>
            </a>
        </div>
    </header>

    <main style="flex:1;padding:20px;background:#f8fafc;">
        <!-- AI Lawyer Assistant Section -->
        <div class="ai-lawyer-container">
            <div class="ai-lawyer-header">
                <div class="ai-lawyer-avatar">
                    <div class="avatar-icon"></div>
                </div>
                <div class="ai-lawyer-info">
                    <h1>AI Form Assistant</h1>
                    <p>Get instant legal guidance and answers to your questions</p>
                    <div class="ai-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Online</span>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <div class="message-avatar"></div>
                        <div class="message-content">
                            <p>Hello! I'm your AI Form Assistant. I can help you with:</p>
                            <ul>
                                <li>General legal questions and guidance</li>
                                <li>Understanding legal processes</li>
                                <li>Assessing your situation and recommending appropriate forms</li>
                                <li>Document preparation assistance</li>
                                <li>Legal terminology explanations</li>
                            </ul>
                            <p><strong>Form Assessment:</strong> I have access to various legal forms and can assess your situation to recommend the most appropriate form for your needs. Just describe your legal situation and I'll help you find the right form!</p>
                            <p><strong>Important:</strong> I provide general information only and cannot replace professional legal advice. For specific legal matters, please consult with a qualified attorney.</p>
                            <p>How can I help you today?</p>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>AI is thinking...</span>
                    </div>
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ask me about your legal question..." 
                            rows="1"
                            maxlength="2000"
                        ></textarea>
                        <button id="sendButton" class="send-button">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <div class="input-footer">
                        <span class="char-count" id="charCount">0/2000</span>
                        <span class="disclaimer-text">AI responses are for informational purposes only</span>
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <h3>Quick Questions</h3>
                <div class="quick-buttons">
                    <button class="quick-btn" data-question="I need to sue someone for money they owe me">Small Claims</button>
                    <button class="quick-btn" data-question="I can't afford to pay court filing fees">Fee Waiver</button>
                    <button class="quick-btn" data-question="Someone is suing me and I want to counter-sue">Counter Claim</button>
                    <button class="quick-btn" data-question="I have a legal issue related to COVID-19">COVID-19 Legal</button>
                    <button class="quick-btn" data-question="What are my rights as a tenant?">Tenant Rights</button>
                    <button class="quick-btn" data-question="How do I start a business?">Business Law</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        &copy; 2024 Placeholder Company. All rights reserved.
    </footer>

    <!-- County Selection Modal -->
    <div id="county-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-modal" id="county-modal-close">&times;</span>
            <h2 id="county-modal-title">Which county are you filing in?</h2>
            <p id="county-modal-message" style="font-size: 1.1em; margin: 20px 0; line-height: 1.5;">Enter your zip code below to determine your county.</p>
            <input type="text" id="county-zip-input" placeholder="Enter zip code" maxlength="5" style="width: 90%; padding: 12px; font-size: 1.1em; border-radius: 6px; border: 2px solid #e2e8f0; margin-bottom: 18px; text-align: center;">
            <div id="county-modal-error" style="color: #e74c3c; font-size: 1em; margin-bottom: 10px; display: none;"></div>
              <div id="county-modal-buttons" style="display: flex; gap: 15px; justify-content: center; margin-top: 10px;">
                  <button type="button" id="county-modal-cancel" class="btn" style="width: auto; padding: 12px 30px; background-color: #95a5a6; border: none; color: white;">Cancel</button>
                  <button type="button" id="county-modal-submit" class="btn" style="width: auto; padding: 12px 30px; background-color: #2980b9; border: none; color: white;">Submit</button>
              </div>
        </div>
    </div>

    <!-- Defendant Name Modal -->
    <div id="defendant-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-modal" id="defendant-modal-close">&times;</span>
            <h2>Defendant Information</h2>
            <p style="font-size: 1.1em; margin: 20px 0; line-height: 1.5;">Who are you suing?</p>
            <input type="text" id="defendant-name-input" placeholder="Enter defendant's name" style="width: 90%; padding: 12px; font-size: 1.1em; border-radius: 6px; border: 2px solid #e2e8f0; margin-bottom: 18px;">
            <div id="defendant-modal-error" style="color: #e74c3c; font-size: 1em; margin-bottom: 10px; display: none;"></div>
              <div style="display: flex; gap: 15px; justify-content: center; margin-top: 10px;">
                  <button type="button" id="defendant-modal-cancel" class="btn" style="width: auto; padding: 12px 30px; background-color: #95a5a6; border: none; color: white;">Cancel</button>
                  <button type="button" id="defendant-modal-submit" class="btn" style="width: auto; padding: 12px 30px; background-color: #2980b9; border: none; color: white;">Submit</button>
              </div>
        </div>
    </div>
    <script>
        // Firebase configuration (matching forms.js)
        const firebaseConfig = {
            apiKey: "AIzaSyDS-tSSn7fdLBgwzfHQ_1MPG1w8S_4qb04",
            authDomain: "formwiz-3f4fd.firebaseapp.com",
            projectId: "formwiz-3f4fd",
            storageBucket: "formwiz-3f4fd.firebasestorage.app",
            messagingSenderId: "404259212529",
            appId: "1:404259212529:web:15a33bce82383b21cfed50",
            measurementId: "G-P07YEN0HPD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- CART SIDE MENU LOGIC ---
        function openCartSideMenu() {
            const cartOverlay = document.getElementById('cart-overlay');
            const cartSideMenu = document.getElementById('cart-side-menu');
            cartOverlay.classList.add('active');
            cartSideMenu.classList.add('active');
            cartOverlay.style.opacity = '1';
            cartOverlay.style.visibility = 'visible';
            document.body.style.overflow = 'hidden';
        }
        function closeCartSideMenu() {
            const cartOverlay = document.getElementById('cart-overlay');
            const cartSideMenu = document.getElementById('cart-side-menu');
            cartOverlay.classList.remove('active');
            cartSideMenu.classList.remove('active');
            cartOverlay.style.opacity = '0';
            cartOverlay.style.visibility = 'hidden';
            document.body.style.overflow = '';
        }

        // Forms data from Firebase (initialize with defaults for immediate availability)
        let availableForms = [
            {
                id: 'sc100',
                name: 'SC-100',
                description: "Plaintiff's Claim form for suing a defendant",
                url: '../Forms/SC-100/sc-100.html?formId=sc100',
                defendant: 'YES'
            },
            {
                id: 'sc120',
                name: 'SC-120',
                description: "Defendant's Claim form for counter-suing",
                url: '../Forms/SC-120/sc-120.html?formId=sc120',
                defendant: 'NO'
            },
            {
                id: 'sc500',
                name: 'SC-500',
                description: 'COVID-19 related small claims form',
                url: '../Forms/SC-500/sc-500.html?formId=sc500',
                defendant: 'NO'
            },
            {
                id: 'fee-waiver',
                name: 'Fee Waiver',
                description: 'Request to waive court filing fees',
                url: '../Forms/fee-waiver.html?formId=fee-waiver',
                defendant: 'NO'
            }
        ];

        // Normalize URLs from Firestore/admin so they point to the correct file
        function normalizeFormUrl(url, formId = null) {
            if (!url) return '';
            let normalized = url.trim();

            // Absolute URLs are left untouched
            if (/^https?:\/\//i.test(normalized)) {
                return normalized;
            }

            // Strip any leading "Forms/" so we can safely prefix
            normalized = normalized.replace(/^\/?Forms\//i, '');

            if (normalized.startsWith('../') || normalized.startsWith('/')) {
                // Already relative or root-relative; keep as-is after Forms strip
                normalized = normalized;
            } else {
                // Prefix with ../Forms/ for pages that live under /Pages or /Bot
                normalized = '../Forms/' + normalized.replace(/^\/+/, '');
            }

            // Append formId if missing
            if (formId && !/formId=/i.test(normalized)) {
                const separator = normalized.includes('?') ? '&' : '?';
                normalized += `${separator}formId=${formId}`;
            }

            return normalized;
        }

        // AI configuration is now handled server-side

        // Chat state management
        let conversationHistory = [];
        let isTyping = false;
        let fallbackMode = false;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const charCount = document.getElementById('charCount');
        const quickButtons = document.querySelectorAll('.quick-btn');

        // Default forms fallback (used if Firebase fails)
        function getDefaultForms() {
            return [
                {
                    id: 'sc100',
                    name: 'SC-100',
                    description: "Plaintiff's Claim form for suing a defendant",
                    url: '../Forms/SC-100/sc-100.html?formId=sc100',
                    defendant: 'YES'
                },
                {
                    id: 'sc120',
                    name: 'SC-120',
                    description: "Defendant's Claim form for counter-suing",
                    url: '../Forms/SC-120/sc-120.html?formId=sc120',
                    defendant: 'NO'
                },
                {
                    id: 'sc500',
                    name: 'SC-500',
                    description: 'COVID-19 related small claims form',
                    url: '../Forms/SC-500/sc-500.html?formId=sc500',
                    defendant: 'NO'
                },
                {
                    id: 'fee-waiver',
                    name: 'Fee Waiver',
                    description: 'Request to waive court filing fees',
                    url: '../Forms/fee-waiver.html?formId=fee-waiver',
                    defendant: 'NO'
                }
            ];
        }

        // Load forms from Firebase
        async function loadFormsFromFirebase() {
            try {
                const snapshot = await db.collection('forms').get();
                availableForms = [];
                
                snapshot.forEach(doc => {
                    const formData = doc.data();
                    formData.id = doc.id;
                    formData.url = formData.url ? normalizeFormUrl(formData.url, formData.id) : normalizeFormUrl(`${formData.id}.html`, formData.id);
                    
                    availableForms.push(formData);
                });
                
                console.log('Loaded forms from Firebase:', availableForms);
                
                // If no forms were loaded, use defaults
                if (availableForms.length === 0) {
                    console.warn('No forms loaded from Firebase, using default forms');
                    availableForms = getDefaultForms();
                }
            } catch (error) {
                console.error('Error loading forms from Firebase:', error);
                // Use default forms as fallback
                console.log('Using default forms as fallback');
                availableForms = getDefaultForms();
            }
        }

        // System prompt is now handled server-side

        // Initialize chat functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadFormsFromFirebase();
            initializeChat();
            initializeQuickButtons();
            initializeInputHandlers();
        });

        function initializeChat() {
            // Ensure chat messages start at the top
            chatMessages.scrollTop = 0;
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Update character count
                const count = this.value.length;
                charCount.textContent = `${count}/2000`;
                
                // Enable/disable send button
                sendButton.disabled = count === 0 || isTyping;
            });

            // Send message on Enter (but allow Shift+Enter for new lines)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Send button click
            sendButton.addEventListener('click', sendMessage);
        }

        function initializeQuickButtons() {
            quickButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const question = this.getAttribute('data-question');
                    messageInput.value = question;
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    charCount.textContent = `${question.length}/2000`;
                    sendButton.disabled = false;
                    sendMessage();
                });
            });
        }

        function initializeInputHandlers() {
            // Focus input on page load
            messageInput.focus();
        }

            // API calls are now handled server-side

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isTyping) return;

            // Add user message
            addMessage('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            charCount.textContent = '0/2000';
            sendButton.disabled = true;

            // Show typing indicator
            showTypingIndicator();

            // Debug: Check if forms are loaded
            console.log('Available forms when sending message:', availableForms);

            // If in fallback mode, use built-in responses
            if (fallbackMode) {
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = getFallbackResponse(message);
                    addMessage('ai', response);
                    
                    // Check if we should add a form module in fallback mode
                    const matchingForms = availableForms.filter(form => {
                        const formName = (form.name || '').toLowerCase();
                        const formDesc = (form.description || '').toLowerCase();
                        const lowerMessage = message.toLowerCase();
                        
                        // Check for fee waiver related keywords
                        if (lowerMessage.includes('fee waiver') || lowerMessage.includes('waive fee') || 
                            lowerMessage.includes('court fee') || lowerMessage.includes('filing fee') ||
                            lowerMessage.includes('can\'t afford') || lowerMessage.includes('financial hardship') ||
                            lowerMessage.includes('waiving') || lowerMessage.includes('waive')) {
                            return formName.includes('fee') || formDesc.includes('fee') || formDesc.includes('waiver');
                        }
                        
                        // Check for counter-sue related keywords (SC-120)
                        if (lowerMessage.includes('counter-sue') || lowerMessage.includes('counter sue') ||
                            lowerMessage.includes('defendant') || lowerMessage.includes('being sued')) {
                            return formName.includes('sc-120') || formDesc.includes('counter');
                        }
                        
                        // Check for small claims related keywords (SC-100)
                        if (lowerMessage.includes('small claims') || lowerMessage.includes('small claim') ||
                            lowerMessage.includes('sue') || lowerMessage.includes('lawsuit') ||
                            lowerMessage.includes('debt') || lowerMessage.includes('money owed')) {
                            // Only match SC-100 if it's not a counter-sue situation
                            if (!lowerMessage.includes('counter') && !lowerMessage.includes('defendant')) {
                                return formName.includes('sc-100') || formDesc.includes('plaintiff');
                            }
                        }
                        
                        // Check for COVID-19 related keywords (SC-500)
                        if (lowerMessage.includes('covid') || lowerMessage.includes('pandemic') ||
                            lowerMessage.includes('coronavirus')) {
                            return formName.includes('sc-500') || formDesc.includes('covid');
                        }
                        
                        return false;
                    });
                    
                    if (matchingForms.length > 0) {
                        setTimeout(() => {
                            addFormRecommendationModule(matchingForms[0]);
                        }, 500);
                    }
                }, 1000);
                return;
            }

            // API calls are now handled server-side

            try {
                // Add to conversation history
                conversationHistory.push({ role: 'user', content: message });

                // Call OpenAI API
                const response = await callOpenAI();
                
                // Hide typing indicator
                hideTypingIndicator();

                // Check if the AI response mentions form recommendations
                // If so, add a form recommendation module
                let finalResponse = response;
                const matchingForms = availableForms.filter(form => {
                    const formName = (form.name || '').toLowerCase();
                    const formDesc = (form.description || '').toLowerCase();
                    const lowerMessage = message.toLowerCase();
                    const lowerResponse = response.toLowerCase();
                    
                    // Check if the response mentions this specific form
                    const mentionsForm = lowerResponse.includes(formName) || 
                                      lowerResponse.includes(formDesc.toLowerCase()) ||
                                      (formName.includes('fee') && lowerResponse.includes('fee waiver')) ||
                                      (formName.includes('sc-100') && lowerResponse.includes('sc-100')) ||
                                      (formName.includes('sc-120') && lowerResponse.includes('sc-120')) ||
                                      (formName.includes('sc-500') && lowerResponse.includes('sc-500'));
                    
                    // Check for specific form mentions in response
                    const specificFormMention = (formName === 'sc-100' && lowerResponse.includes('sc-100')) ||
                                              (formName === 'sc-120' && lowerResponse.includes('sc-120')) ||
                                              (formName === 'sc-500' && lowerResponse.includes('sc-500')) ||
                                              (formName.includes('fee') && lowerResponse.includes('fee waiver'));
                    
                    // Also check for keyword matches with more specific logic
                    const keywordMatch = (lowerMessage.includes('fee waiver') || lowerMessage.includes('waive fee') || 
                                        lowerMessage.includes('court fee') || lowerMessage.includes('filing fee') ||
                                        lowerMessage.includes('can\'t afford') || lowerMessage.includes('financial hardship') ||
                                        lowerMessage.includes('waiving') || lowerMessage.includes('waive')) &&
                                       (formName.includes('fee') || formDesc.includes('fee') || formDesc.includes('waiver')) ||
                                       
                                       (lowerMessage.includes('counter-sue') || lowerMessage.includes('counter sue') ||
                                        lowerMessage.includes('defendant') || lowerMessage.includes('being sued')) &&
                                       (formName.includes('sc-120') || formDesc.includes('counter')) ||
                                       
                                       (lowerMessage.includes('sue') || lowerMessage.includes('lawsuit') ||
                                        lowerMessage.includes('debt') || lowerMessage.includes('money owed')) &&
                                       !lowerMessage.includes('counter') && !lowerMessage.includes('defendant') &&
                                       (formName.includes('sc-100') || formDesc.includes('plaintiff')) ||
                                       
                                       (lowerMessage.includes('covid') || lowerMessage.includes('pandemic') ||
                                        lowerMessage.includes('coronavirus')) &&
                                       (formName.includes('sc-500') || formDesc.includes('covid'));
                    
                    return mentionsForm || specificFormMention || keywordMatch;
                });
                
                if (matchingForms.length > 0) {
                    console.log('Matching forms found:', matchingForms);
                    console.log('Selected form for module:', matchingForms[0]);
                    // Add form recommendation module after the AI response
                    setTimeout(() => {
                        addFormRecommendationModule(matchingForms[0]);
                    }, 500);
                }

                // Add AI response
                addMessage('ai', finalResponse);
                conversationHistory.push({ role: 'assistant', content: finalResponse });

            } catch (error) {
                hideTypingIndicator();
                console.error('Error calling OpenAI API:', error);
                
                let errorMessage = 'I apologize, but I encountered an error. ';
                
                if (error.message.includes('429') || error.message.includes('quota')) {
                    errorMessage += 'It looks like you\'ve exceeded your OpenAI API quota. Please check your billing details at https://platform.openai.com/account/billing or try again later.';
                } else if (error.message.includes('401') || error.message.includes('unauthorized')) {
                    errorMessage += 'There seems to be an issue with your API key. Please check that it\'s correct and has the proper permissions.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'There\'s a network connectivity issue. Please check your internet connection and try again.';
                } else {
                    errorMessage += 'Please check your API key and try again. If the problem persists, please contact support.';
                }
                
                addMessage('ai', errorMessage);
                
                // Offer fallback mode
                if (error.message.includes('429') || error.message.includes('quota')) {
                    setTimeout(() => {
                        addMessage('ai', 'Would you like me to provide some general legal information using my built-in knowledge base instead? Click "Yes" to continue with basic legal guidance.');
                        addFallbackOption();
                    }, 2000);
                }
            }
        }

        async function callOpenAI() {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: conversationHistory[conversationHistory.length - 1].content,
                    conversationHistory: conversationHistory.slice(0, -1) // Exclude the current message
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server request failed');
            }

            const data = await response.json();
            return data.response;
        }

        function addMessage(sender, content, autoScroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const avatar = sender === 'ai' ? '' : '';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <p>${formatMessage(content)}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Only auto-scroll if this is a new user message or AI response
            // Don't auto-scroll for the initial welcome message
            if (autoScroll) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function addFormRecommendationModule(form) {
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'form-recommendation-module';
            
            // Get appropriate icon for the form
            let iconSvg = '';
            if (form.name.toLowerCase().includes('fee')) {
                iconSvg = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <path d="M19 15L20.09 19.26L24 20L20.09 20.74L19 25L17.91 20.74L14 20L17.91 19.26L19 15Z" fill="currentColor"/>
                </svg>`;
            } else if (form.name.toLowerCase().includes('sc')) {
                iconSvg = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 21H21V19H3V21ZM5 17H19V15H5V17ZM7 13H17V11H7V13ZM9 9H15V7H9V9ZM11 5H13V3H11V5Z" fill="currentColor"/>
                </svg>`;
            } else {
                iconSvg = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20Z" fill="currentColor"/>
                </svg>`;
            }
            
            moduleDiv.innerHTML = `
                <div class="form-module-header">
                    <div class="form-module-icon">
                        ${iconSvg}
                    </div>
                    <div>
                        <h3 class="form-module-title">${form.name}</h3>
                        <p class="form-module-subtitle">Recommended Form</p>
                    </div>
                </div>
                <div class="form-module-description">
                    ${form.description}
                </div>
                <div class="form-module-actions">
                    <button class="form-get-started-btn" onclick="showCountyModal('${form.id}', '${form.url}', '${form.name.replace(/'/g, "\\'")}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 6H6C4.9 6 4 6.9 4 8V18C4 19.1 4.9 20 6 20H16C17.1 20 18 19.1 18 18V14M14 4H20M20 4V10M20 4L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Get Started
                    </button>
                    <span class="form-module-info">Click to start the form process</span>
                </div>
            `;
            
            chatMessages.appendChild(moduleDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(content) {
            // Convert line breaks to HTML
            return content.replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            isTyping = true;
            typingIndicator.style.display = 'flex';
            sendButton.disabled = true;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            isTyping = false;
            typingIndicator.style.display = 'none';
            sendButton.disabled = false;
        }

        function addFallbackOption() {
            const fallbackHtml = `
                <div class="message ai-message">
                    <div class="message-avatar"></div>
                    <div class="message-content">
                        <button id="enableFallback" class="btn" style="margin: 10px 5px; padding: 8px 16px; font-size: 0.9em;">
                            Yes, Use Basic Legal Guidance
                        </button>
                        <button id="retryApi" class="btn" style="margin: 10px 5px; padding: 8px 16px; font-size: 0.9em; background: #95a5a6;">
                            Retry API
                        </button>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', fallbackHtml);
            
            document.getElementById('enableFallback').addEventListener('click', enableFallbackMode);
            document.getElementById('retryApi').addEventListener('click', retryApiCall);
        }

        function enableFallbackMode() {
            fallbackMode = true;
            addMessage('ai', 'Great! I\'m now in basic guidance mode. I can provide general legal information and direct you to helpful resources. What legal topic would you like to know about?');
        }

        function retryApiCall() {
            fallbackMode = false;
            addMessage('ai', 'Retrying API connection...');
            // Remove the fallback buttons
            const fallbackButtons = document.querySelectorAll('#enableFallback, #retryApi');
            fallbackButtons.forEach(btn => btn.parentElement.parentElement.remove());
        }

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check if any available forms match the user's situation
            const matchingForms = availableForms.filter(form => {
                const formName = (form.name || '').toLowerCase();
                const formDesc = (form.description || '').toLowerCase();
                
                // Check for fee waiver related keywords
                if (lowerMessage.includes('fee waiver') || lowerMessage.includes('waive fee') || 
                    lowerMessage.includes('court fee') || lowerMessage.includes('filing fee') ||
                    lowerMessage.includes('can\'t afford') || lowerMessage.includes('financial hardship') ||
                    lowerMessage.includes('waiving') || lowerMessage.includes('waive')) {
                    return formName.includes('fee') || formDesc.includes('fee') || formDesc.includes('waiver');
                }
                
                // Check for small claims related keywords
                if (lowerMessage.includes('small claims') || lowerMessage.includes('small claim') ||
                    lowerMessage.includes('sue') || lowerMessage.includes('lawsuit') ||
                    lowerMessage.includes('debt') || lowerMessage.includes('money owed')) {
                    return formName.includes('sc') || formDesc.includes('claim') || formDesc.includes('sue');
                }
                
                // Check for COVID-19 related keywords
                if (lowerMessage.includes('covid') || lowerMessage.includes('pandemic') ||
                    lowerMessage.includes('coronavirus')) {
                    return formDesc.includes('covid') || formDesc.includes('pandemic');
                }
                
                return false;
            });
            
            // If we found matching forms, recommend them
            if (matchingForms.length > 0) {
                let response = `It sounds like we have just what you need! Based on your situation, I recommend these forms:\n\n`;
                
                matchingForms.forEach(form => {
                    response += `**${form.name}**\n`;
                    response += `${form.description}\n\n`;
                });
                
                response += `These forms should help you with your specific situation. Make sure to read all instructions carefully and consider consulting with a qualified attorney if you have any questions.\n\n`;
                response += `*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
                
                return response;
            }
            
            // Fallback to general responses if no forms match
            if (lowerMessage.includes('small claims') || lowerMessage.includes('small claim')) {
                return `For small claims court cases, here's what you typically need:

**Required Documents:**
 Complaint form (filed with the court)
 Proof of service (showing the defendant was notified)
 Evidence supporting your claim (receipts, contracts, photos, etc.)
 Any correspondence with the defendant

**Process:**
1. File your complaint with the court
2. Pay the filing fee (usually $25-100)
3. Serve the defendant with court papers
4. Attend the hearing with your evidence

**Important:** Small claims limits vary by state (usually $3,000-$10,000). Check your local court's website for specific requirements.

*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
            }
            
            if (lowerMessage.includes('divorce') || lowerMessage.includes('divorce process')) {
                return `The divorce process typically involves these steps:

**Initial Steps:**
 Determine if you meet residency requirements
 Decide on grounds for divorce (fault vs. no-fault)
 Gather financial documents and asset information

**Filing Process:**
1. File a petition for divorce with the court
2. Serve your spouse with divorce papers
3. Wait for response period (usually 20-30 days)
4. Negotiate settlement or proceed to trial

**Key Considerations:**
 Child custody and support arrangements
 Division of marital property and debts
 Spousal support/alimony
 Legal representation (recommended for complex cases)

**Important:** Divorce laws vary significantly by state. Consider consulting with a family law attorney for guidance specific to your situation.

*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
            }
            
            if (lowerMessage.includes('probate') || lowerMessage.includes('will')) {
                return `Probate is the legal process of distributing a deceased person's assets. Here's what you should know:

**When Probate is Needed:**
 Person dies with assets in their name only
 No living trust or joint ownership
 Assets exceed state's small estate limits

**Probate Process:**
1. File petition with probate court
2. Notify heirs and creditors
3. Inventory and appraise assets
4. Pay debts and taxes
5. Distribute remaining assets to beneficiaries

**Avoiding Probate:**
 Living trusts
 Joint ownership with right of survivorship
 Beneficiary designations on accounts
 Transfer-on-death deeds

**Important:** Probate laws vary by state and can be complex. Consider consulting with an estate planning attorney.

*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
            }
            
            if (lowerMessage.includes('tenant') || lowerMessage.includes('rent') || lowerMessage.includes('landlord')) {
                return `As a tenant, you have important rights and responsibilities:

**Tenant Rights:**
 Right to habitable living conditions
 Right to privacy (landlord must give notice before entering)
 Right to security deposit return (if no damages)
 Protection against illegal eviction

**Landlord Responsibilities:**
 Maintain safe and habitable premises
 Make necessary repairs
 Provide proper notice for entry
 Follow legal eviction procedures

**Common Issues:**
 Security deposit disputes
 Maintenance and repair problems
 Lease violations
 Eviction proceedings

**Important:** Tenant-landlord laws vary by state and locality. Document everything and consider consulting with a housing attorney for serious disputes.

*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
            }
            
            if (lowerMessage.includes('business') || lowerMessage.includes('start a business')) {
                return `Starting a business involves several legal considerations:

**Business Structure Options:**
 Sole Proprietorship (simplest, but unlimited personal liability)
 Partnership (shared ownership and liability)
 LLC (limited liability, flexible management)
 Corporation (strongest liability protection, more complex)

**Key Steps:**
1. Choose business structure
2. Register with state (if required)
3. Obtain necessary licenses and permits
4. Get federal tax ID (EIN)
5. Open business bank account
6. Consider insurance needs

**Important Legal Areas:**
 Contracts and agreements
 Employment law (if hiring)
 Tax obligations
 Intellectual property protection

**Important:** Business law is complex and varies by state. Consider consulting with a business attorney to ensure proper setup and compliance.

*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
            }
            
            // Default response for general questions
            return `I can provide general information about various legal topics. Here are some areas I can help with:

**Common Legal Topics:**
 Small Claims Court procedures
 Divorce and family law basics
 Probate and estate planning
 Tenant and landlord rights
 Business formation and law
 Contract basics
 Employment law fundamentals

**Important Reminders:**
 This is general information only
 Laws vary by state and locality
 Every situation is unique
 Always consult with a qualified attorney for specific legal advice

What specific legal topic would you like to know more about?

*This is general information only. Please consult with a qualified attorney for specific legal advice.*`;
        }

        // Legacy functions for existing page functionality
        function initializeLegacyFeatures() {
            // Dynamic How It Works image switching
            const steps = document.querySelectorAll('.hiw-step');
            const images = document.querySelectorAll('.hiw-image');
            let activeStep = 0;

            function setActiveStep(idx) {
                steps.forEach((step, i) => {
                    if (i === idx) {
                        step.classList.add('active');
                        images[i].classList.add('active');
                    } else {
                        step.classList.remove('active');
                        images[i].classList.remove('active');
                    }
                });
                activeStep = idx;
            }

            // Click to activate step
            steps.forEach((step, idx) => {
                step.addEventListener('click', () => setActiveStep(idx));
            });

            // Scroll-based activation
            function onScroll() {
                let found = false;
                steps.forEach((step, idx) => {
                    const rect = step.getBoundingClientRect();
                    if (!found && rect.top < window.innerHeight/2 && rect.bottom > window.innerHeight/2) {
                        setActiveStep(idx);
                        found = true;
                    }
                });
            }
            window.addEventListener('scroll', onScroll);
        }

        // Hero animation on load
        function initializeHeroAnimation() {
            const heroH1 = document.querySelector('.hero-content h1');
            const heroP = document.querySelector('.hero-content p');
            if (heroH1 && heroP) {
                setTimeout(() => {
                    heroH1.classList.add('hero-animate');
                }, 100);
                setTimeout(() => {
                    heroP.classList.add('hero-animate');
                }, 450);
            }
        }

        // Dropdown for Forms nav
        function initializeDropdown() {
            const formsWrapper = document.getElementById('forms-dropdown-wrapper');
            const formsLink = document.getElementById('forms-nav-link');
            const dropdownMenu = document.getElementById('forms-dropdown-menu');
            let dropdownOpen = false;

            function openDropdown() {
                formsWrapper.classList.add('open');
                dropdownOpen = true;
            }
            function closeDropdown() {
                formsWrapper.classList.remove('open');
                dropdownOpen = false;
            }
            formsLink.addEventListener('click', function(e) {
                e.preventDefault();
                dropdownOpen ? closeDropdown() : openDropdown();
            });
            document.addEventListener('mousedown', function(e) {
                if (!formsWrapper.contains(e.target)) {
                    closeDropdown();
                }
            });
            // Keyboard accessibility
            formsLink.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    dropdownOpen ? closeDropdown() : openDropdown();
                }
            });
        }

        // County and Defendant Modal Functions
        let countyZipMap = null;
        let pendingCountyData = null;
        let currentCounty = null;
        let pendingDefendantData = null;

        // Load county-zip mapping
        async function loadCountyZipMap() {
            if (countyZipMap) return countyZipMap;
            try {
                const response = await fetch('../JSON/county-zips.json');
                if (!response.ok) throw new Error('Failed to load county-zips.json');
                countyZipMap = await response.json();
                return countyZipMap;
            } catch (e) {
                console.error('Error loading county-zips.json:', e);
                return {};
            }
        }

        // County Selection Modal
        function showCountyModal(formId, formUrl, formName) {
            console.log(' DEBUG: showCountyModal called with:', { formId, formUrl, formName });
            
            const modal = document.getElementById('county-modal');
            const closeBtn = document.getElementById('county-modal-close');
            const submitBtn = document.getElementById('county-modal-submit');
            const cancelBtn = document.getElementById('county-modal-cancel');
            const zipInput = document.getElementById('county-zip-input');
            const errorDiv = document.getElementById('county-modal-error');
            const title = document.getElementById('county-modal-title');
            const message = document.getElementById('county-modal-message');
            
            console.log(' DEBUG: Modal elements found:', { modal, closeBtn, submitBtn, cancelBtn, zipInput, errorDiv, title, message });
            
            // Reset modal to initial state
            title.textContent = 'Which county are you filing in?';
            message.textContent = 'Enter your zip code below to determine your county.';
            zipInput.style.display = 'block';
            zipInput.value = '';
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            submitBtn.textContent = 'Submit';
            submitBtn.style.display = 'block';
            cancelBtn.style.display = 'block';
            modal.style.display = 'block';
            
            pendingCountyData = { formId, formUrl, formName };
            currentCounty = null;
            
            console.log(' DEBUG: Modal displayed, pendingCountyData set:', pendingCountyData);
            
            function closeModal() {
                modal.style.display = 'none';
                pendingCountyData = null;
                currentCounty = null;
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            window.onclick = function(event) {
                if (event.target == modal) closeModal();
            };
            
            // Handle zip code input - only allow numbers
            zipInput.addEventListener('input', function() {
                let val = zipInput.value.replace(/\D/g, '');
                if (val.length > 5) val = val.slice(0, 5);
                zipInput.value = val;
            });
            
            submitBtn.onclick = async function() {
                console.log(' DEBUG: Submit button clicked, currentCounty:', currentCounty);
                
                if (!currentCounty) {
                    console.log(' DEBUG: First step - validating zip code');
                    // First step: validate zip code and find county
                    const zipValue = zipInput.value.trim();
                    console.log(' DEBUG: Zip value entered:', zipValue);
                    
                    if (!zipValue || zipValue.length !== 5) {
                        console.log(' DEBUG: Invalid zip code');
                        errorDiv.textContent = 'Please enter a valid 5-digit zip code.';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    // Find county for this zip
                    console.log(' DEBUG: Loading county zip map');
                    const countyZipMap = await loadCountyZipMap();
                    console.log(' DEBUG: County zip map loaded:', countyZipMap);
                    
                    let foundCounty = null;
                    for (const [county, zips] of Object.entries(countyZipMap)) {
                        if (zips.includes(zipValue)) {
                            foundCounty = county;
                            console.log(' DEBUG: Found county:', foundCounty);
                            break;
                        }
                    }
                    
                    if (!foundCounty) {
                        console.log(' DEBUG: No county found for zip:', zipValue);
                        errorDiv.textContent = 'No county found for this zip code.';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    // Check if form supports this county
                    let formObj = availableForms.find(f => f.id === formId);
                    if (formObj && (!Array.isArray(formObj.counties) || !formObj.counties.includes(foundCounty))) {
                        errorDiv.textContent = `This form is not offered in ${foundCounty} County. Please try a different zip code.`;
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    // Show confirmation step
                    currentCounty = foundCounty;
                    // Store the zip code for later use
                    if (pendingCountyData) {
                        pendingCountyData.zipCode = zipValue;
                    }
                    title.textContent = 'Confirm County';
                    message.textContent = `Great, you're filing in ${foundCounty} County right?`;
                    zipInput.style.display = 'none';
                    errorDiv.style.display = 'none';
                    submitBtn.textContent = 'Yes';
                    cancelBtn.textContent = 'No';
                    
                } else {
                    // Second step: user confirmed county, proceed with form addition
                    modal.style.display = 'none';
                    
                    if (pendingCountyData) {
                        // Check for duplicates (only if user is logged in)
                        const user = auth.currentUser;
                        
                        if (!user) {
                            // If not logged in, check if form requires defendant first
                            let formObj = availableForms.find(f => f.id === pendingCountyData.formId);
                            
                            if (formObj && formObj.defendant && formObj.defendant.toUpperCase() === 'YES') {
                                // Show defendant modal
                                showDefendantModal(formObj, pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty, pendingCountyData.zipCode);
                            } else {
                                // Redirect to form directly
                                const separator = pendingCountyData.formUrl.includes('?') ? '&' : '?';
                                const redirectUrl = pendingCountyData.formUrl + separator + 'county=' + encodeURIComponent(currentCounty);
                                window.location.href = redirectUrl;
                            }
                            pendingCountyData = null;
                            currentCounty = null;
                            return;
                        }
                        
                        const userId = user.uid;
                        try {
                            const formsSnapshot = await db.collection('users').doc(userId).collection('forms').get();
                            let duplicateFound = false;
                            
                            formsSnapshot.forEach(doc => {
                                const formData = doc.data();
                                if ((formData.originalFormId === pendingCountyData.formId || doc.id === pendingCountyData.formId) && formData.countyName === currentCounty) {
                                    duplicateFound = true;
                                }
                            });
                            
                            if (duplicateFound) {
                                // Check if duplicate form modal exists and use it, otherwise proceed
                                let formObj = availableForms.find(f => f.id === pendingCountyData.formId);
                                if (formObj && formObj.defendant && formObj.defendant.toUpperCase() === 'YES') {
                                    showDefendantModal(formObj, pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty, pendingCountyData.zipCode, true);
                                } else {
                                    await addFormToPortfolioInternal(pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty, true);
                                }
                            } else {
                                // Check if form requires defendant
                                let formObj = availableForms.find(f => f.id === pendingCountyData.formId);
                                
                                if (formObj && formObj.defendant && formObj.defendant.toUpperCase() === 'YES') {
                                    showDefendantModal(formObj, pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty, pendingCountyData.zipCode);
                                } else {
                                    await addFormToPortfolioInternal(pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty);
                                }
                            }
                        } catch (error) {
                            console.error('Error checking for duplicate form:', error);
                            // On error, still check for defendant requirement
                            let formObj = availableForms.find(f => f.id === pendingCountyData.formId);
                            if (formObj && formObj.defendant && formObj.defendant.toUpperCase() === 'YES') {
                                showDefendantModal(formObj, pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty, pendingCountyData.zipCode);
                            } else {
                                await addFormToPortfolioInternal(pendingCountyData.formId, pendingCountyData.formUrl, pendingCountyData.formName, currentCounty);
                            }
                        }
                        
                        pendingCountyData = null;
                        currentCounty = null;
                    }
                }
            };
            
            // Handle "No" button - go back to zip code input
            cancelBtn.onclick = function() {
                if (currentCounty) {
                    // Go back to zip code input
                    title.textContent = 'Which county are you filing in?';
                    message.textContent = 'Enter your zip code below to determine your county.';
                    zipInput.style.display = 'block';
                    zipInput.value = '';
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = '';
                    submitBtn.textContent = 'Submit';
                    cancelBtn.textContent = 'Cancel';
                    currentCounty = null;
                } else {
                    closeModal();
                }
            };
        }

        // Defendant Name Modal
        function showDefendantModal(formObj, formId, formUrl, formName, countyName, zipCode = null, isDuplicate = false) {
            const modal = document.getElementById('defendant-modal');
            const closeBtn = document.getElementById('defendant-modal-close');
            const submitBtn = document.getElementById('defendant-modal-submit');
            const cancelBtn = document.getElementById('defendant-modal-cancel');
            const input = document.getElementById('defendant-name-input');
            const errorDiv = document.getElementById('defendant-modal-error');
            input.value = '';
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            modal.style.display = 'block';
            pendingDefendantData = { formObj, formId, formUrl, formName, countyName, zipCode, isDuplicate };
            
            function closeModal() {
                modal.style.display = 'none';
                pendingDefendantData = null;
            }
            
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            window.onclick = function(event) {
                if (event.target == modal) closeModal();
            };
            
            submitBtn.onclick = async function() {
                const defendantName = input.value.trim();
                if (!defendantName) {
                    errorDiv.textContent = 'Please enter the defendant\'s name.';
                    errorDiv.style.display = 'block';
                    return;
                }
                modal.style.display = 'none';
                if (pendingDefendantData) {
                    await addFormToPortfolioInternal(
                        pendingDefendantData.formId,
                        pendingDefendantData.formUrl,
                        pendingDefendantData.formName,
                        pendingDefendantData.countyName,
                        pendingDefendantData.isDuplicate,
                        defendantName
                    );
                    pendingDefendantData = null;
                }
            };
        }

        // Add form to portfolio
        async function addFormToPortfolioInternal(formId, formUrl, formName, countyName, isDuplicate = false, defendantName = null) {
            const user = auth.currentUser;
            
            if (!user) {
                // If not logged in, redirect to form directly (like forms.js does)
                const separator = formUrl.includes('?') ? '&' : '?';
                let url = formUrl + separator + 'county=' + encodeURIComponent(countyName);
                if (defendantName) url += '&defendantName=' + encodeURIComponent(defendantName);
                // Include zip code in URL if available
                const zipCode = (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode);
                if (zipCode) {
                    url += '&zipCode=' + encodeURIComponent(zipCode);
                }
                window.location.href = url;
                return;
            }
            
            const userId = user.uid;
            console.log(' DEBUG: User ID:', userId);
            
            try {
                if (isDuplicate) {
                    console.log(' DEBUG: Creating duplicate form');
                    // For duplicates, always create a new document with a unique ID
                    const newFormRef = db.collection('users').doc(userId).collection('forms').doc();
                    const formData = {
                        originalFormId: formId,
                        name: formName,
                        url: formUrl,
                        addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastOpened: firebase.firestore.FieldValue.serverTimestamp(),
                        countyName: countyName,
                        isDuplicate: true,
                        zipCode: (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode) ? (pendingCountyData ? pendingCountyData.zipCode : pendingDefendantData.zipCode) : null
                    };
                    if (defendantName) formData.defendantName = defendantName;
                    
                    console.log(' DEBUG: Setting duplicate form data:', formData);
                    await newFormRef.set(formData);
                    console.log(' DEBUG: Duplicate form set successfully');
                    
                    // Verify the form was actually stored by reading it back
                    const verifyDoc = await newFormRef.get();
                    if (verifyDoc.exists) {
                        const storedData = verifyDoc.data();
                        console.log(' DEBUG: Verification successful, stored data:', storedData);
                        
                        // Show success alert with debug info
                        console.log(' DEBUG: ===== SUCCESS: Duplicate form added =====');
                        alert(` Form successfully added to portfolio!\n\nDebug Info:\n- Form ID: ${formId}\n- Form Name: ${formName}\n- County: ${countyName}\n- Portfolio ID: ${newFormRef.id}\n- Stored Name Field: ${storedData.name}\n- Defendant Name: ${defendantName || 'N/A'}\n- Is Duplicate: ${isDuplicate}\n\nClick OK to proceed to the form.`);
                        
                        // Redirect to form
                        const separator = formUrl.includes('?') ? '&' : '?';
                        let url = formUrl + separator + 'county=' + encodeURIComponent(countyName);
                        url += '&portfolioId=' + encodeURIComponent(newFormRef.id);
                        if (defendantName) url += '&defendantName=' + encodeURIComponent(defendantName);
                        // Include zip code in URL if available
                        const zipCode = (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode);
                        if (zipCode) {
                            url += '&zipCode=' + encodeURIComponent(zipCode);
                        }
                        console.log(' DEBUG: Redirecting to form:', url);
                        window.location.href = url;
                    } else {
                        console.error(' DEBUG: Failed to verify duplicate form was stored!');
                        alert(' Error: Form was not properly stored in portfolio. Please try again.');
                    }
                } else {
                    console.log(' DEBUG: Creating new form (not duplicate)');
                    // For new forms, check if it already exists for the same county
                    const formsSnapshot = await db.collection('users').doc(userId).collection('forms').get();
                    console.log(' DEBUG: Existing forms count:', formsSnapshot.size);
                    
                    let existingFormDoc = null;
                    
                    formsSnapshot.forEach(doc => {
                        const formData = doc.data();
                        console.log(' DEBUG: Checking existing form:', { docId: doc.id, formData });
                        // Check if this is the same form type and same county
                        if ((formData.originalFormId === formId || doc.id === formId) && formData.countyName === countyName) {
                            existingFormDoc = doc;
                            console.log(' DEBUG: Found existing form for same county');
                        }
                    });
                    
                    if (existingFormDoc) {
                        console.log(' DEBUG: Updating existing form');
                        // Update lastOpened in Firestore for the existing form
                        await existingFormDoc.ref.update({
                            lastOpened: firebase.firestore.FieldValue.serverTimestamp(),
                            countyName: countyName,
                            zipCode: (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode) ? (pendingCountyData ? pendingCountyData.zipCode : pendingDefendantData.zipCode) : null
                        });
                        console.log(' DEBUG: Existing form updated successfully');
                        
                        // Verify the form was actually updated by reading it back
                        const verifyDoc = await existingFormDoc.ref.get();
                        if (verifyDoc.exists) {
                            const storedData = verifyDoc.data();
                            console.log(' DEBUG: Verification successful, updated data:', storedData);
                            
                            // Show success alert with debug info
                            console.log(' DEBUG: ===== SUCCESS: Existing form updated =====');
                            alert(` Form successfully updated in portfolio!\n\nDebug Info:\n- Form ID: ${formId}\n- Form Name: ${formName}\n- County: ${countyName}\n- Portfolio ID: ${existingFormDoc.id}\n- Stored Name Field: ${storedData.name}\n- Defendant Name: ${defendantName || 'N/A'}\n- Is Existing Form: true\n\nClick OK to proceed to the form.`);
                            
                            // Redirect to form
                            const separator = formUrl.includes('?') ? '&' : '?';
                            let url = formUrl + separator + 'county=' + encodeURIComponent(countyName);
                            url += '&portfolioId=' + encodeURIComponent(existingFormDoc.id);
                            if (defendantName) url += '&defendantName=' + encodeURIComponent(defendantName);
                            // Include zip code in URL if available
                            const zipCode = (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode);
                            if (zipCode) {
                                url += '&zipCode=' + encodeURIComponent(zipCode);
                            }
                            console.log(' DEBUG: Redirecting to form:', url);
                            window.location.href = url;
                        } else {
                            console.error(' DEBUG: Failed to verify existing form was updated!');
                            alert(' Error: Form was not properly updated in portfolio. Please try again.');
                        }
                    } else {
                        console.log(' DEBUG: Creating new form document');
                        // Create a new form document with auto-generated ID
                        const newFormRef = db.collection('users').doc(userId).collection('forms').doc();
                        const formData = {
                            originalFormId: formId,
                            name: formName,
                            url: formUrl,
                            addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastOpened: firebase.firestore.FieldValue.serverTimestamp(),
                            countyName: countyName,
                            zipCode: (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode) ? (pendingCountyData ? pendingCountyData.zipCode : pendingDefendantData.zipCode) : null
                        };
                        if (defendantName) formData.defendantName = defendantName;
                        
                        console.log(' DEBUG: Setting new form data:', formData);
                        await newFormRef.set(formData);
                        console.log(' DEBUG: New form set successfully');
                        
                        // Verify the form was actually stored by reading it back
                        const verifyDoc = await newFormRef.get();
                        if (verifyDoc.exists) {
                            const storedData = verifyDoc.data();
                            console.log(' DEBUG: Verification successful, stored data:', storedData);
                            
                            // Show success alert with debug info
                            console.log(' DEBUG: ===== SUCCESS: New form added =====');
                            alert(` Form successfully added to portfolio!\n\nDebug Info:\n- Form ID: ${formId}\n- Form Name: ${formName}\n- County: ${countyName}\n- Portfolio ID: ${newFormRef.id}\n- Stored Name Field: ${storedData.name}\n- Defendant Name: ${defendantName || 'N/A'}\n- Is New Form: true\n\nClick OK to proceed to the form.`);
                            
                            // Redirect to form
                            const separator = formUrl.includes('?') ? '&' : '?';
                            let url = formUrl + separator + 'county=' + encodeURIComponent(countyName);
                            url += '&portfolioId=' + encodeURIComponent(newFormRef.id);
                            if (defendantName) url += '&defendantName=' + encodeURIComponent(defendantName);
                            // Include zip code in URL if available
                            const zipCode = (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode);
                            if (zipCode) {
                                url += '&zipCode=' + encodeURIComponent(zipCode);
                            }
                            console.log(' DEBUG: Redirecting to form:', url);
                            window.location.href = url;
                        } else {
                            console.error(' DEBUG: Failed to verify new form was stored!');
                            alert(' Error: Form was not properly stored in portfolio. Please try again.');
                        }
                    }
                }
            } catch (error) {
                console.error(' DEBUG: ===== ERROR IN addFormToPortfolioInternal =====');
                console.error(' DEBUG: Error handling form:', error);
                console.error(' DEBUG: Error details:', {
                    message: error.message,
                    stack: error.stack,
                    formId,
                    formName,
                    countyName,
                    userId
                });
                console.log(' DEBUG: Redirecting to form due to error (no portfolio ID available)');
                const separator = formUrl.includes('?') ? '&' : '?';
                let url = formUrl + separator + 'county=' + encodeURIComponent(countyName);
                if (defendantName) url += '&defendantName=' + encodeURIComponent(defendantName);
                // Include zip code in URL if available
                const zipCode = (pendingCountyData && pendingCountyData.zipCode) || (pendingDefendantData && pendingDefendantData.zipCode);
                if (zipCode) {
                    url += '&zipCode=' + encodeURIComponent(zipCode);
                }
                window.location.href = url;
            }
            
            // Reset variables after URL construction
            pendingCountyData = null;
            currentCounty = null;
            pendingDefendantData = null;
            
            console.log(' DEBUG: ===== addFormToPortfolioInternal END =====');
        }

        // Update cart count badge in header
        function updateCartCountBadge() {
            const cartCountElement = document.getElementById('cart-count-badge');
            if (cartCountElement) {
                let count = 0;
                
                // Try to get count from getCartCount function first
                if (typeof getCartCount === 'function') {
                    count = getCartCount();
                } else {
                    // Fallback to localStorage
                    try {
                        const cartData = localStorage.getItem('formwiz_cart');
                        if (cartData) {
                            const cart = JSON.parse(cartData);
                            count = Array.isArray(cart) ? cart.length : 0;
                        }
                    } catch (e) {
                        count = 0;
                    }
                }
                
                // Always update the text content, even if count is 0
                cartCountElement.textContent = count;
                
                if (count > 0) {
                    cartCountElement.style.display = 'flex';
                } else {
                    cartCountElement.style.display = 'none';
                }
            }
        }

        // Initialize header features (dropdown, auth, cart)
        function initializeHeaderFeatures() {
            // Forms dropdown functionality
            const formsWrapper = document.getElementById('forms-dropdown-wrapper');
            const formsLink = document.getElementById('forms-nav-link');
            const formsMenu = document.getElementById('forms-dropdown-menu');
            
            if (formsLink && formsMenu) {
                formsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    formsWrapper.classList.toggle('open');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!formsWrapper.contains(e.target)) {
                        formsWrapper.classList.remove('open');
                    }
                });
            }
            
            // Authentication state management
            const signInBtn = document.getElementById('sign-in-btn');
            const logoutBtn = document.getElementById('logout-btn');
            
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    if (signInBtn) signInBtn.style.display = 'none';
                    if (logoutBtn) logoutBtn.style.display = 'inline-block';
                } else {
                    if (signInBtn) signInBtn.style.display = 'inline-block';
                    if (logoutBtn) logoutBtn.style.display = 'none';
                }
            });
            
            // Logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        window.location.href = '../index.html';
                    }).catch((error) => {
                        alert('Sign Out Error: ' + error.message);
                    });
                });
            }
            
            // Cart functionality (matching forms.js exactly)
            const cartIconLink = document.getElementById('cart-icon-link');
            const cartOverlay = document.getElementById('cart-overlay');
            const cartSideMenu = document.getElementById('cart-side-menu');
            const cartCloseBtn = document.getElementById('cart-close-btn');
            const cartContent = document.getElementById('cart-content');
            const cartMessage = document.getElementById('cart-message');
            const cartDescription = document.getElementById('cart-description');
            const cartSignupBtn = document.getElementById('cart-signup-btn');
            const cartItemsList = document.getElementById('cart-items-list');
            const cartCheckoutBtn = document.getElementById('cart-checkout-btn');
            
            if (cartIconLink) {
                cartIconLink.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (auth.currentUser) {
                        openCartSideMenu();
                        cartMessage.style.display = 'none';
                        cartDescription.style.display = 'none';
                        cartSignupBtn.style.display = 'none';
                        cartItemsList.style.display = 'block';
                        cartCheckoutBtn.style.display = 'none';
                        cartItemsList.innerHTML = '';
                        // --- Use formwiz_cart cookie for cart data (like cart.html) ---
                        function getCookie(name) {
                            const eq = name + '=';
                            const parts = document.cookie.split(';');
                            for (let c of parts) {
                                while (c.charAt(0) === ' ') c = c.slice(1);
                                if (c.indexOf(eq) === 0) return c.slice(eq.length);
                            }
                            return null;
                        }
                        let cart = [];
                        try {
                            // Try cookie first, then localStorage as fallback
                            let cartData = getCookie('formwiz_cart');
                            if (!cartData) {
                                cartData = localStorage.getItem('formwiz_cart');
                            }
                            if (cartData) {
                                // Decode URL-encoded data if needed
                                const decodedData = cartData.startsWith('%') ? decodeURIComponent(cartData) : cartData;
                                cart = JSON.parse(decodedData);
                            }
                        } catch (e) { 
                            console.error('Error parsing cart data:', e);
                            cart = []; 
                        }
                        if (!Array.isArray(cart) || cart.length === 0) {
                            cartItemsList.innerHTML = '<div style="color:#7f8c8d;font-size:1.1em;margin-top:18px;">Your cart is empty.</div>';
                            cartCheckoutBtn.style.display = 'none';
                            return;
                        }
                        let total = 0;
                        // Fetch prices for all items (simulate fetchStripePrice)
                        async function fetchStripePrice(priceId) {
                            try {
                                const res = await fetch(`/stripe-price/${priceId}`, { mode: 'cors' });
                                if (!res.ok) return null;
                                const data = await res.json();
                                return data;
                            } catch {
                                return null;
                            }
                        }
                        // Render cart items with price fetch
                        cartItemsList.innerHTML = '<div style="color:#7f8c8d;font-size:1.1em;margin-top:18px;">Loading cart...</div>';
                        let html = '';
                        let totalAmount = 0;
                        let itemCount = 0;
                        for (const item of cart) {
                            const priceInfo = await fetchStripePrice(item.priceId);
                            let display = '...';
                            let priceVal = 0;
                            if (priceInfo && priceInfo.unit_amount != null) {
                                display = `$${(priceInfo.unit_amount / 100).toFixed(2)}`;
                                priceVal = priceInfo.unit_amount / 100;
                                totalAmount += priceVal;
                            }
                            // Capitalize defendant's name if present
                            let defendantDisplay = '';
                            if (item.defendantName) {
                                const capName = String(item.defendantName)
                                  .split(/\s+/)
                                  .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                                  .join(' ');
                                defendantDisplay = `<div style='font-weight:bold;color:#e74c3c;'>Defendant: ${capName}</div>`;
                            }
                            html += `
                                <div class="cart-item">
                                    <div class="cart-item-info">
                                        <div class="cart-item-title">${item.title || 'Form'}</div>
                                        ${defendantDisplay}
                                        ${item.countyName ? `<div class='cart-item-county' style='font-size:0.98em;color:#153a5b;margin-bottom:2px;'>${item.countyName}${item.countyName.toLowerCase().includes('county') ? '' : ' County'}</div>` : ''}
                                        <div class="cart-item-price">${display}</div>
                                    </div>
                                    <button class="remove-item" title="Remove" onclick="(function(){const cart=JSON.parse(decodeURIComponent(document.cookie.split('; ').find(row=>row.startsWith('formwiz_cart='))?.split('=')[1]||'[]'));cart.splice(${itemCount},1);document.cookie='formwiz_cart='+encodeURIComponent(JSON.stringify(cart))+';path=/;max-age=2592000';window.location.reload();})()">
                                        <svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 20 20' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='3 6 5 6 21 6'></polyline><path d='M19 6l-2 14H7L5 6'></path><path d='M10 11v6'></path><path d='M14 11v6'></path><path d='M5 6V4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2'></path></svg>
                                    </button>
                                </div>
                            `;
                            itemCount++;
                        }
                        // Total and checkout
                        html += `<div class="cart-summary">
                            <div class="summary-label">Total:</div>
                            <div class="total-amount">$${totalAmount.toFixed(2)}</div>
                        </div>`;
                        cartItemsList.innerHTML = html;
                        cartCheckoutBtn.style.display = 'block';
                    } else {
                        openCartSideMenu();
                        cartMessage.style.display = 'block';
                        cartDescription.style.display = 'block';
                        cartSignupBtn.style.display = 'inline-block';
                        cartItemsList.style.display = 'none';
                        cartCheckoutBtn.style.display = 'none';
                    }
                });
            }
            if (cartCloseBtn) {
                cartCloseBtn.addEventListener('click', closeCartSideMenu);
            }
            if (cartOverlay) {
                cartOverlay.addEventListener('click', function(e) {
                    if (e.target === cartOverlay) closeCartSideMenu();
                });
            }
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeCartSideMenu();
            });
            if (cartCheckoutBtn) {
                cartCheckoutBtn.addEventListener('click', function() {
                    window.location.href = '../Pages/cart.html';
                });
            }
            
            // Initialize cart count badge
            updateCartCountBadge();
            setInterval(updateCartCountBadge, 5000);
        }

        // Keyboard shortcut to trigger SC-100 form (Ctrl+Shift)
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.shiftKey) {
                event.preventDefault();
                console.log(' DEBUG: Ctrl+Shift pressed - triggering SC-100 form');
                
                // Find the SC-100 form and trigger its "Get Started" function
                const sc100Form = availableForms.find(form => form.id === 'sc100');
                if (sc100Form) {
                    console.log(' DEBUG: Found SC-100 form:', sc100Form);
                    showCountyModal(sc100Form.id, sc100Form.url, sc100Form.name);
                } else {
                    console.log(' DEBUG: SC-100 form not found in availableForms');
                    alert('SC-100 form not available. Please try again later.');
                }
            }
        });

        // Initialize all features
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure page starts at the top
            window.scrollTo(0, 0);
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
            
            // Initialize header functionality
            initializeHeaderFeatures();
            
            initializeLegacyFeatures();
            initializeHeroAnimation();
            initializeDropdown();
        });
    </script>

    <!-- Cart Overlay (matching forms.html exactly) -->
    <div class="cart-overlay" id="cart-overlay">
        <div class="cart-side-menu" id="cart-side-menu">
            <div class="cart-header">
                <h2> Cart</h2>
                <button class="cart-close-btn" id="cart-close-btn">&times;</button>
            </div>
            <div class="cart-content" id="cart-content">
                <div class="cart-icon-large"></div>
                <div class="cart-message" id="cart-message">Create an account to start shopping!</div>
                <div class="cart-description" id="cart-description">
                    To add forms to your cart and make purchases, you'll need to create a FormWiz account. 
                    Sign up now to access our complete library of legal forms and start simplifying your paperwork.
                </div>
                <a href="../Pages/account.html" class="cart-signup-btn" id="cart-signup-btn">Sign Up</a>
                <div class="cart-items-list" id="cart-items-list" style="display:none;"></div>
                <button class="cart-checkout-btn" id="cart-checkout-btn" style="display:none;margin-top:24px;background:#2980b9;color:#fff;padding:15px 40px;font-size:1.1em;font-weight:700;border:none;border-radius:8px;cursor:pointer;">Checkout</button>
            </div>
        </div>
    </div>
    <!-- Authentication Script -->
    <script src="../auth.js"></script>
</body>
</html>
