<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Form Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f4f8fb;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 48px auto 32px auto;
            background: #fff;
            border-radius: 22px;
            box-shadow: 0 8px 32px rgba(44,62,80,0.13);
            padding: 44px 38px 38px 38px;
        }
        h1 {
            text-align: center;
            color: #2980b9;
            margin-bottom: 28px;
            font-size: 2.4em;
            font-weight: 800;
            letter-spacing: 0.01em;
        }
        .import-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
            margin-bottom: 36px;
        }
        .import-section > * {
            margin-bottom: 0 !important;
        }
        .custom-file-input {
            position: relative;
            display: inline-block;
        }
        .custom-file-input input[type="file"] {
            opacity: 0;
            width: 0.1px;
            height: 0.1px;
            position: absolute;
            z-index: -1;
        }
        .custom-file-label {
            display: inline-block;
            background: #eaf6ff;
            color: #2980b9;
            border: 2px solid #b3e0ff;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, border 0.18s;
        }
        .custom-file-label:hover {
            background: #d4eafd;
            color: #1c598a;
            border: 2px solid #2980b9;
        }
        .import-section button, .add-form-btn, .export-btn {
            background: linear-gradient(90deg, #2980b9 0%, #4f8cff 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 12px 28px;
            font-size: 1.08em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s, transform 0.18s;
            box-shadow: 0 2px 8px rgba(44,62,80,0.10);
        }
        .import-section button:hover, .add-form-btn:hover, .export-btn:hover {
            background: linear-gradient(90deg, #1c598a 0%, #2980b9 100%);
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 4px 16px rgba(44,62,80,0.13);
        }
        .add-form-btn {
            margin-bottom: 22px;
            display: block;
            margin-left: auto;
        }
        .export-btn {
            float: right;
            margin-bottom: 22px;
        }
        .forms-table-wrapper {
            background: #f8fbff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(44,62,80,0.08);
            padding: 18px 10px 10px 10px;
        }
        .forms-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 0;
        }
        .forms-table th, .forms-table td {
            padding: 14px 12px;
            text-align: left;
            font-size: 1.08em;
        }
        .forms-table th {
            background: #eaf6ff;
            color: #2980b9;
            font-weight: 800;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border-bottom: 2px solid #b3e0ff;
        }
        .forms-table tr {
            transition: background 0.18s;
        }
        .forms-table tbody tr:nth-child(even) {
            background: #f0f6fa;
        }
        .forms-table tbody tr:nth-child(odd) {
            background: #fff;
        }
        .forms-table td {
            border-bottom: 1.5px solid #e0e6ea;
        }
        .form-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2980b9;
            padding: 16px 12px;
        }
        .form-description {
            color: #5a6c7d;
            font-size: 0.95em;
            line-height: 1.4;
            padding: 16px 12px;
            max-width: 300px;
        }
        .form-actions {
            text-align: center;
            padding: 12px;
        }
        .forms-table td input, .forms-table td textarea {
            width: 100%;
            font-size: 1em;
            padding: 8px 10px;
            border-radius: 7px;
            border: 1.5px solid #b3e0ff;
            background: #f8fbff;
            transition: border 0.18s, box-shadow 0.18s;
        }
        .forms-table td input:focus, .forms-table td textarea:focus {
            border: 2px solid #2980b9;
            box-shadow: 0 0 0 2px #b3e0ff33;
            outline: none;
        }
        .forms-table td textarea {
            resize: vertical;
            min-height: 32px;
        }
        .action-btn {
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            margin: 2px 4px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(44,62,80,0.12);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .action-btn.edit {
            background: linear-gradient(135deg, #2980b9 0%, #4f8cff 100%);
        }
        .action-btn.edit:hover {
            background: linear-gradient(135deg, #1c598a 0%, #2980b9 100%);
            transform: translateY(-1px) scale(1.04);
        }
        .action-btn.delete:hover {
            background: #c0392b;
            transform: translateY(-1px) scale(1.04);
        }
        .action-btn:active {
            transform: scale(0.97);
        }
        .download-section {
            text-align: center;
            margin-top: 24px;
            padding: 20px;
        }
        .download-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .download-btn:hover {
            background: linear-gradient(135deg, #219150 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        .download-btn:active {
            transform: translateY(0);
        }
        .no-forms {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.15em;
            margin: 38px 0;
        }
        .county-select {
            width: 100%;
            min-height: 38px;
            border-radius: 7px;
            border: 1.5px solid #b3e0ff;
            background: #f8fbff;
            font-size: 1em;
            padding: 8px 10px;
            margin-top: 2px;
        }
        .county-select:focus {
            border: 2px solid #2980b9;
            box-shadow: 0 0 0 2px #b3e0ff33;
            outline: none;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fff;
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 650px;
            max-height: 90vh;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            background: linear-gradient(135deg, #2980b9 0%, #4f8cff 100%);
            color: white;
            padding: 28px 36px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }
        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.2s;
        }
        .close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 36px;
            background: linear-gradient(135deg, #f8fbff 0%, #ffffff 100%);
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #2980b9 #e0e6ea;
        }
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #e0e6ea;
            border-radius: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #2980b9;
            border-radius: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #1c598a;
        }
        .form-group {
            margin-bottom: 28px;
            position: relative;
        }
        .form-group label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
            gap: 8px;
        }
        .form-group label::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #2980b9, #4f8cff);
            border-radius: 2px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: calc(100% - 36px);
            padding: 14px 18px;
            border: 2px solid #e0e6ea;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 4px rgba(41, 128, 185, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group small {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 4px;
            display: block;
        }
        .modal-footer {
            padding: 28px 36px;
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4fd 100%);
            border-radius: 0 0 20px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            border-top: 1px solid rgba(41, 128, 185, 0.1);
            flex-shrink: 0;
        }
        .btn-cancel,
        .btn-save {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-cancel {
            background: linear-gradient(135deg, #e0e6ea 0%, #d5dbe0 100%);
            color: #2c3e50;
        }
        .btn-cancel:hover {
            background: linear-gradient(135deg, #d5dbe0 0%, #c8d0d8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .btn-save {
            background: linear-gradient(135deg, #2980b9 0%, #4f8cff 100%);
            color: white;
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #1c598a 0%, #2980b9 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.4);
        }

        @media (max-width: 800px) {
            .container { padding: 12px 2vw; }
            .forms-table th, .forms-table td { font-size: 0.98em; }
            .forms-table-wrapper { padding: 6px 2px 2px 2px; }
            .modal-content { width: 95%; margin: 10% auto; }
            .modal-header, .modal-body, .modal-footer { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Form Manager</h1>
        <div class="import-section">
            <span class="custom-file-input">
                <label class="custom-file-label" for="import-json">Choose JSON File</label>
                <input type="file" id="import-json" accept="application/json">
            </span>
            <span id="file-name" style="font-size:1.08em;color:#2980b9;font-weight:600;">Loading forms from Firebase...</span>
            <button class="export-btn" id="export-btn">Save All Changes</button>
        </div>
        <button class="add-form-btn" id="add-form-btn">+ Add New Form</button>
        <div class="forms-table-wrapper" id="forms-table-wrapper"></div>
        <div class="download-section">
            <button class="download-btn" id="download-json-btn">üì• Download JSON</button>
        </div>
    </div>

    <!-- Edit Form Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Form</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <div class="form-group">
                        <label for="edit-name">üìù Name *</label>
                        <input type="text" id="edit-name" required placeholder="Enter form name">
                    </div>
                    <div class="form-group">
                        <label for="edit-id">üè∑Ô∏è ID *</label>
                        <input type="text" id="edit-id" required placeholder="Enter unique form ID">
                    </div>
                    <div class="form-group">
                        <label for="edit-description">üìÑ Description</label>
                        <textarea id="edit-description" rows="3" placeholder="Enter form description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-url">üîó URL Base</label>
                        <input type="text" id="edit-url" placeholder="e.g., sc100">
                    </div>
                    <div class="form-group">
                        <label for="edit-counties">üó∫Ô∏è Counties *</label>
                        <select id="edit-counties" multiple required>
                            <option value="Monterey">Monterey</option>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple counties</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-defendant">‚öñÔ∏è Defendant</label>
                        <select id="edit-defendant">
                            <option value="N/A">N/A</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeEditModal()">‚ùå Cancel</button>
                <button type="button" class="btn-save" onclick="saveFormChanges()">üíæ Save Changes</button>
            </div>
        </div>
    </div>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyACh8hp2kL4P0xBPkwkvpLA0zNAqtw5IQc",
            authDomain: "invoice-4f2b4.firebaseapp.com",
            projectId: "invoice-4f2b4",
            storageBucket: "invoice-4f2b4.firebasestorage.app",
            messagingSenderId: "1028270499799",
            appId: "1:1028270499799:web:31401d335232bb21bc4d92",
            measurementId: "G-Z1HX6QN3DG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let formsData = [];
        let fileName = 'available-forms.json';
        let currentEditIndex = -1;

        // California counties list
        const COUNTY_LIST = [
            "Alameda", "Alpine", "Amador", "Butte", "Calaveras", "Colusa", "Contra Costa", "Del Norte", "El Dorado", "Fresno", "Glenn", "Humboldt", "Imperial", "Inyo", "Kern", "Kings", "Lake", "Lassen", "Los Angeles", "Madera", "Marin", "Mariposa", "Mendocino", "Merced", "Modoc", "Mono", "Monterey", "Napa", "Nevada", "Orange", "Placer", "Plumas", "Riverside", "Sacramento", "San Benito", "San Bernardino", "San Diego", "San Francisco", "San Joaquin", "San Luis Obispo", "San Mateo", "Santa Barbara", "Santa Clara", "Santa Cruz", "Shasta", "Sierra", "Siskiyou", "Solano", "Sonoma", "Stanislaus", "Sutter", "Tehama", "Trinity", "Tulare", "Tuolumne", "Ventura", "Yolo", "Yuba"
        ];

        // Load forms data from Firebase Firestore
        async function loadFormsData() {
            try {
                document.getElementById('file-name').textContent = 'Loading forms from Firebase...';
                
                const snapshot = await db.collection('forms').get();
                formsData = [];
                
                snapshot.forEach(doc => {
                    const formData = doc.data();
                    formData.id = doc.id; // Use document ID as form ID
                    formsData.push(formData);
                });
                
                // Normalize defendant field names and values, and ensure description field exists
                formsData.forEach(form => {
                    if (form.defendent && !form.defendant) {
                        form.defendant = form.defendent;
                        delete form.defendent;
                    }
                    if (form.defendant === 'YES') {
                        form.defendant = 'Yes';
                    }
                    // Ensure description field exists for backward compatibility
                    if (!form.description) {
                        form.description = '';
                    }
                });
                
                // Sort alphabetically by name after loading
                formsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                renderFormsTable();
                document.getElementById('file-name').textContent = `Loaded ${formsData.length} forms from Firebase`;
            } catch (error) {
                console.error('Error loading forms from Firebase:', error);
                document.getElementById('file-name').textContent = 'Error loading forms from Firebase - ' + error.message;
                renderFormsTable();
            }
        }

        // Remove Edit button from table rows and center Add New Form button
        function renderFormsTable() {
            const wrapper = document.getElementById('forms-table-wrapper');
            if (!formsData.length) {
                wrapper.innerHTML = '<div class="no-forms">No forms loaded. Import a JSON file or add a new form.</div>';
                return;
            }
            // Sort forms alphabetically by name before rendering
            formsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            let table = `<table class="forms-table"><thead><tr>
                <th>Name</th><th>Description</th><th>Actions</th>
            </tr></thead><tbody>`;
            formsData.forEach((form, idx) => {
                table += `<tr>
                    <td class="form-name">${form.name || 'Unnamed Form'}</td>
                    <td class="form-description">${form.description || 'No description provided'}</td>
                    <td class="form-actions">
                        <button class="action-btn edit" onclick="openEditModal(${idx})">‚úèÔ∏è Edit</button>
                        <button class="action-btn delete" onclick="deleteForm(${idx})">üóëÔ∏è Delete</button>
                    </td>
                </tr>`;
            });
            table += '</tbody></table>';
            document.getElementById('forms-table-wrapper').innerHTML = table;
        }

        function renderCountySelect(idx, selectedCounties) {
            let html = `<select multiple class="county-select" id="county-select-${idx}">`;
            COUNTY_LIST.forEach(county => {
                html += `<option value="${county}"${selectedCounties.includes(county) ? ' selected' : ''}>${county}</option>`;
            });
            html += '</select>';
            return html;
        }

        function renderDefendantSelect(idx, selectedDefendant) {
            let html = `<select class="county-select" id="defendant-select-${idx}">`;
            html += `<option value="N/A"${selectedDefendant === 'N/A' ? ' selected' : ''}>N/A</option>`;
            html += `<option value="Yes"${selectedDefendant === 'Yes' || selectedDefendant === 'YES' ? ' selected' : ''}>Yes</option>`;
            html += '</select>';
            return html;
        }

        // Update a field in a form
        window.updateFormField = function(idx, field, value) {
            if (field === 'counties') {
                formsData[idx][field] = value;
            } else if (field === 'url') {
                // Auto-generate full URL from base
                const base = value.trim();
                formsData[idx][field] = base ? `${base}.html?formId=${base}` : '';
            } else if (field === 'defendant') {
                // Normalize defendant field and remove old spelling
                formsData[idx]['defendant'] = value;
                delete formsData[idx]['defendent'];
            } else if (field === 'description') {
                formsData[idx][field] = value;
            } else {
                formsData[idx][field] = value;
            }
        };

        // Edit (focus) a form row
        window.editForm = function(idx) {
            const wrapper = document.getElementById('forms-table-wrapper');
            const row = wrapper.querySelectorAll('tbody tr')[idx];
            if (row) {
                row.querySelectorAll('input')[0].focus();
            }
        };

        // Delete a form
        window.deleteForm = async function(idx) {
            if (confirm('Are you sure you want to delete this form?')) {
                try {
                    const form = formsData[idx];
                    if (form.id) {
                        // Delete from Firebase
                        await db.collection('forms').doc(form.id).delete();
                    }
                    
                    // Remove from local data
                formsData.splice(idx, 1);
                renderFormsTable();
                    
                    document.getElementById('file-name').textContent = 'Form deleted from Firebase successfully';
                } catch (error) {
                    console.error('Error deleting form from Firebase:', error);
                    alert('Error deleting form from Firebase: ' + error.message);
                }
            }
        };

        // Add a new form
        document.getElementById('add-form-btn').onclick = function() {
            // Generate a unique ID for the new form
            const newId = 'form_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Add new form to data
            formsData.push({ id: newId, name: 'New Form', description: '', url: '', counties: ['Monterey'], defendant: 'N/A' });
            currentEditIndex = formsData.length - 1;
            
            // Clear form fields
            document.getElementById('edit-name').value = 'New Form';
            document.getElementById('edit-id').value = newId;
            document.getElementById('edit-description').value = '';
            document.getElementById('edit-url').value = '';
            
            // Set up counties select
            const countiesSelect = document.getElementById('edit-counties');
            countiesSelect.innerHTML = '';
            COUNTY_LIST.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                if (county === 'Monterey') {
                    option.selected = true;
                }
                countiesSelect.appendChild(option);
            });
            
            document.getElementById('edit-defendant').value = 'N/A';
            
            // Update modal header
            document.querySelector('.modal-header h2').textContent = 'Add New Form';
            
            // Show modal
            document.getElementById('edit-modal').style.display = 'block';
        };

        // Save forms data to Firebase Firestore
        async function saveFormsData() {
            try {
                document.getElementById('file-name').textContent = 'Saving changes to Firebase...';
                
                // Sort alphabetically by name before saving
                formsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                // Save each form to Firebase
                const batch = db.batch();
                
                for (const form of formsData) {
                    const formRef = db.collection('forms').doc(form.id);
                    const { id, ...formData } = form; // Remove id from data since it's the document ID
                    batch.set(formRef, formData);
                }
                
                await batch.commit();
                
                // Update status message
                document.getElementById('file-name').textContent = `Successfully saved ${formsData.length} forms to Firebase`;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                document.getElementById('file-name').textContent = 'Error saving to Firebase - ' + error.message;
            }
        }

        // Center the Add New Form button
        document.getElementById('add-form-btn').style.display = 'block';
        document.getElementById('add-form-btn').style.margin = '0 auto 22px auto';

        // Save Changes button
        document.getElementById('export-btn').onclick = function() {
            saveFormsData();
        };

        // Download JSON button
        document.getElementById('download-json-btn').onclick = function() {
            // Sort alphabetically by name before export
            formsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            const json = JSON.stringify({ forms: formsData }, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'forms-export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('file-name').textContent = 'Forms exported to forms-export.json';
        };

        // Import JSON functionality
        document.getElementById('import-json').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('file-name').textContent = 'Importing ' + file.name + '...';
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        const importedForms = Array.isArray(json.forms) ? json.forms : json;
                        
                        // Normalize defendant field names and values, and ensure description field exists
                        importedForms.forEach(form => {
                            if (form.defendent && !form.defendant) {
                                form.defendant = form.defendent;
                                delete form.defendent;
                            }
                            if (form.defendant === 'YES') {
                                form.defendant = 'Yes';
                            }
                            // Ensure description field exists for backward compatibility
                            if (!form.description) {
                                form.description = '';
                            }
                            // Generate unique ID if not present
                            if (!form.id) {
                                form.id = 'form_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                        });
                        
                        // Replace current forms data with imported data
                        formsData = importedForms;
                        
                        // Sort alphabetically by name after import
                        formsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                        renderFormsTable();
                        
                        document.getElementById('file-name').textContent = `Imported ${formsData.length} forms from ${file.name}. Click "Save All Changes" to upload to Firebase.`;
                    } catch (err) {
                        console.error('Error parsing JSON:', err);
                        document.getElementById('file-name').textContent = 'Error: Invalid JSON file format.';
                        alert('Invalid JSON file. Please check the file format and try again.');
                    }
                };
                reader.readAsText(file);
            }
        });

        // Modal Functions
        function openEditModal(index) {
            currentEditIndex = index;
            const form = formsData[index];
            
            // Update modal header
            document.querySelector('.modal-header h2').textContent = 'Edit Form';
            
            // Populate form fields
            document.getElementById('edit-name').value = form.name || '';
            document.getElementById('edit-id').value = form.id || '';
            document.getElementById('edit-description').value = form.description || '';
            
            // Handle URL - extract base from full URL
            const urlBase = (form.url || '').split('.html')[0] || '';
            document.getElementById('edit-url').value = urlBase;
            
            // Handle counties - populate select with all counties and select current ones
            const countiesSelect = document.getElementById('edit-counties');
            countiesSelect.innerHTML = '';
            COUNTY_LIST.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                if ((form.counties || []).includes(county)) {
                    option.selected = true;
                }
                countiesSelect.appendChild(option);
            });
            
            // Handle defendant
            document.getElementById('edit-defendant').value = form.defendant || 'N/A';
            
            // Show modal
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditIndex = -1;
        }

        async function saveFormChanges() {
            if (currentEditIndex === -1) return;
            
            // Get form values
            const name = document.getElementById('edit-name').value.trim();
            const id = document.getElementById('edit-id').value.trim();
            const description = document.getElementById('edit-description').value.trim();
            const urlBase = document.getElementById('edit-url').value.trim();
            const counties = Array.from(document.getElementById('edit-counties').selectedOptions).map(opt => opt.value);
            const defendant = document.getElementById('edit-defendant').value;
            
            // Validate required fields
            if (!name || !id) {
                alert('Name and ID are required fields.');
                return;
            }
            
            try {
                // Update form data
                formsData[currentEditIndex].name = name;
                formsData[currentEditIndex].id = id;
                formsData[currentEditIndex].description = description;
                formsData[currentEditIndex].url = urlBase ? `${urlBase}.html?formId=${urlBase}` : '';
                formsData[currentEditIndex].counties = counties;
                formsData[currentEditIndex].defendant = defendant;
                
                // Save to Firebase
                const formRef = db.collection('forms').doc(id);
                const { id: formId, ...formData } = formsData[currentEditIndex];
                await formRef.set(formData);
                
                // Re-render table
        renderFormsTable();
                
                // Close modal
                closeEditModal();
                
                // Show success message
                const isNewForm = currentEditIndex === formsData.length - 1 && formsData[currentEditIndex].id === '';
                document.getElementById('file-name').textContent = isNewForm ? 'New form added to Firebase successfully' : 'Form updated in Firebase successfully';
            } catch (error) {
                console.error('Error saving form to Firebase:', error);
                alert('Error saving form to Firebase: ' + error.message);
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Load forms data on page load
        loadFormsData();
    </script>
</body>
</html> 